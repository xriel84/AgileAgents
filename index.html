<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGILE LENS v8</title>
    <link href="https://fonts.googleapis.com/css2?family=Poiret+One&family=Josefin+Sans:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #c9a84c;
            --black: #0a0a0a;
            --cream: #f5e6c8;
            --red: #e63946;
            --blue: #457b9d;
            --yellow: #f1b844;
            --green: #2a9d8f;
            --dark-gray: #1a1a1a;
            --medium-gray: #2d2d2d;
            --transition: 600ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Josefin Sans', sans-serif;
            background: #050505;
            color: var(--cream);
            overflow: hidden;
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        body::after {
            content: '';
            position: fixed; inset: 0;
            pointer-events: none; z-index: 9999; opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)'/%3E%3C/svg%3E");
        }

        /* ========== PROSCENIUM THEATER — FULLSCREEN STAGE ========== */
        #theater { width: 100vw; height: 100vh; position: relative; }
        #stage { position: absolute; inset: 0; overflow: hidden; perspective: 1200px; }
        /* Wings hidden — available for future contextual reveals */
        .wing { display: none; }

        /* View transitions handled by GSAP — no CSS transition to avoid double-interpolation */
        .view {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
        }
        .view.active { opacity: 1; pointer-events: auto; }

        /* ========== NARRATIVE OVERLAY ========== */
        #narrativeOverlay {
            position: fixed;
            bottom: 60px; left: 50%;
            transform: translateX(-50%);
            background: rgba(10,10,10,0.9);
            border: 1px solid var(--gold);
            padding: 12px 24px;
            font-family: 'Space Mono', monospace;
            font-size: 12px; color: var(--gold);
            max-width: 700px; text-align: center;
            letter-spacing: 0.5px;
            opacity: 0; transition: opacity 0.5s;
            z-index: 900; pointer-events: none;
        }
        #narrativeOverlay.visible { opacity: 1; }

        /* ========== PIPELINE GLOW ========== */
        .room.pipeline-active {
            box-shadow: 0 0 30px 8px var(--glow-color, var(--gold));
            border-color: var(--glow-color, var(--gold));
            transform: translateZ(12px);
            z-index: 20;
            transition: box-shadow 0.3s ease, border-color 0.3s ease, transform 0.3s ease;
        }
        .room.pipeline-active .room-panel img {
            opacity: 1;
            filter: drop-shadow(0 6px 18px rgba(201,168,76,0.4)) brightness(1.15);
            transition: filter 0.3s ease, opacity 0.3s ease;
        }
        .room.pipeline-pulse {
            animation: cubiclePulse 1s ease-in-out 2;
        }
        @keyframes cubiclePulse {
            0%, 100% { box-shadow: 0 0 15px 4px var(--glow-color, var(--gold)); transform: translateZ(8px); }
            50% { box-shadow: 0 0 40px 12px var(--glow-color, var(--gold)); transform: translateZ(14px); }
        }
        /* Single pipeline ticker bar — anchored bottom of viewport */
        .pipeline-ticker {
            position: fixed;
            bottom: 36px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(5,5,5,0.92);
            backdrop-filter: blur(8px);
            border: 1px solid var(--gold);
            padding: 10px 28px;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 13px;
            color: var(--cream);
            letter-spacing: 0.5px;
            z-index: 950;
            pointer-events: none;
            text-align: center;
            max-width: 80%;
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        .pipeline-ticker.active { opacity: 1; }
        .pipeline-ticker .ticker-step {
            color: var(--gold);
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            letter-spacing: 1px;
            margin-right: 10px;
        }
        .pipeline-run-btn {
            position: absolute;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10,10,10,0.9);
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 12px 40px;
            font-family: 'Poiret One', cursive;
            font-size: 20px;
            letter-spacing: 3px;
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(201,168,76,0.25);
            animation: btnPulse 2.5s ease-in-out infinite;
        }
        @keyframes btnPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(201,168,76,0.25); }
            50% { box-shadow: 0 0 35px rgba(201,168,76,0.5); }
        }
        .pipeline-run-btn:hover {
            background: var(--gold);
            color: var(--black);
            box-shadow: 0 0 30px rgba(201,168,76,0.7);
            animation: none;
        }
        .pipeline-run-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(10,10,10,0.85);
            color: var(--gold);
            animation: none;
        }

        /* ========== COMIC PANEL POPUPS (pipeline) ========== */
        .comic-panel {
            position: fixed;
            top: 60px;
            width: 220px;
            z-index: 500;
            opacity: 0;
            transform: scale(0.7) translateY(20px);
            transition: opacity 0.35s ease, transform 0.35s ease;
            pointer-events: none;
        }
        .comic-panel.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        .comic-panel.fade-out {
            opacity: 0;
            transform: scale(0.85) translateY(-10px);
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .comic-panel.panel-left { left: 40px; }
        .comic-panel.panel-right { right: 40px; }
        .comic-panel-frame {
            border: 3px solid currentColor;
            background: #0a0a0a;
            padding: 4px;
            position: relative;
            overflow: hidden;
        }
        .comic-panel-frame img {
            display: block;
            width: 100%;
            height: 180px;
            object-fit: contain;
            background: #111;
        }
        .comic-panel-caption {
            border: 2px solid currentColor;
            border-top: none;
            background: rgba(10,10,10,0.95);
            padding: 8px 10px;
            font-family: 'Fira Code', monospace;
            font-size: 10px;
            letter-spacing: 0.5px;
            line-height: 1.4;
            color: currentColor;
            text-transform: uppercase;
        }
        .comic-panel-name {
            font-family: 'Poiret One', cursive;
            font-size: 14px;
            letter-spacing: 2px;
            margin-bottom: 4px;
            font-weight: bold;
        }

        /* ========== ANIMATED WEBP ENGINE ========== */
        /* Browsers loop animated WebP natively — no frame cycling needed.
           We just swap img.src for state changes (idle/working/reaction). */
        .sprite-anim {
            image-rendering: auto; /* WebP looks better with auto */
            transition: opacity 0.15s ease;
        }

        /* Brain split-screen entrance handled by GSAP — no CSS transition */

        /* Click reaction flash */
        .sprite-anim.reacting {
            filter: brightness(1.3) drop-shadow(0 0 8px var(--glow-color, var(--gold)));
            transition: filter 0.15s;
        }

        /* §9 — Development tier indicators */
        .tier-t0 { filter: grayscale(1) opacity(0.4); }
        .tier-t0 .sprite-anim { animation: none !important; }
        .tier-t1 { filter: none; position: relative; }
        .tier-t1::after {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.1) 2px, rgba(255,255,255,0.1) 3px);
            animation: glitch 0.3s infinite;
            pointer-events: none;
        }
        @keyframes glitch {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            50% { transform: translateX(1px); }
            75% { transform: translateX(-1px); }
            100% { transform: translateX(0); }
        }
        .tier-t2 { box-shadow: 0 0 12px 2px var(--yellow); animation: tierPulse 2s infinite; }
        @keyframes tierPulse {
            0%, 100% { box-shadow: 0 0 12px 2px var(--yellow); }
            50% { box-shadow: 0 0 20px 4px var(--yellow); }
        }
        .tier-t3 { box-shadow: 0 0 8px 2px var(--green); }

        /* ========== EXTERIOR ========== */
        #exterior {
            background: radial-gradient(ellipse at 50% 120%, #1a1520 0%, #0a0a0a 60%);
            overflow: hidden;
        }
        .city-scene { position: relative; width: 100%; height: 100%; }
        .stars { position: absolute; inset: 0; }
        .star {
            position: absolute; width: 2px; height: 2px;
            background: var(--cream); border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite alternate;
        }
        @keyframes twinkle { 0% { opacity: 0.2; } 100% { opacity: 0.8; } }
        .ground {
            position: absolute; bottom: 0; left: -10%; width: 120%; height: 35%;
            background: linear-gradient(to bottom, #0d0d0d, #111);
            transform: perspective(600px) rotateX(25deg);
            transform-origin: bottom center;
        }
        .ground::before {
            content: ''; position: absolute; inset: 0;
            background:
                repeating-linear-gradient(90deg, transparent, transparent 80px, rgba(201,168,76,0.06) 80px, rgba(201,168,76,0.06) 81px),
                repeating-linear-gradient(0deg, transparent, transparent 40px, rgba(201,168,76,0.04) 40px, rgba(201,168,76,0.04) 41px);
        }
        /* Hero building — center skyline image as clickable entry */
        .hero-building {
            position: absolute;
            bottom: 18%;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 50;
            animation: heroGlow 3s ease-in-out infinite;
        }
        .hero-building img {
            max-height: 55vh;
            height: auto;
            object-fit: contain;
            filter: brightness(0.9);
        }
        @keyframes heroGlow {
            0%, 100% { filter: drop-shadow(0 0 15px rgba(201,168,76,0.4)); }
            50% { filter: drop-shadow(0 0 35px rgba(201,168,76,0.8)); }
        }
        .hero-building:hover {
            animation: none;
            filter: drop-shadow(0 0 50px rgba(201,168,76,1)) brightness(1.15);
        }
        .click-prompt {
            position: absolute; bottom: 8%; left: 50%;
            transform: translateX(-50%);
            font-family: 'Poiret One', cursive;
            font-size: 16px; color: var(--gold);
            letter-spacing: 3px; animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.9; } }
        .exterior-subtitle {
            position: absolute; top: 12%; left: 50%;
            transform: translateX(-50%);
            font-family: 'Poiret One', cursive;
            font-size: 13px; color: var(--gold);
            letter-spacing: 4px; opacity: 0.6;
        }

        /* ========== INTERIOR (ISOMETRIC) ========== */
        #interior {
            background: var(--black);
            perspective: 1200px;
            flex-direction: column;
            overflow: hidden;
        }

        /* Skyline parallax depth layers behind the floor */
        .skyline-wrap {
            position: absolute; inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        .skyline-depth {
            position: absolute;
            left: 0; right: 0;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 0;
        }
        .skyline-depth img {
            width: auto;
            object-fit: contain;
            flex-shrink: 0;
        }
        /* Size order: back (fullscreen cover) > front (full height) > mid (smallest) */
        .skyline-depth.depth-back { opacity: 0.25; top: 0; bottom: 0; }
        .skyline-depth.depth-back img { width: 100%; height: 100%; object-fit: cover; }
        .skyline-depth.depth-mid { opacity: 0.35; bottom: 44%; }
        .skyline-depth.depth-mid img { height: 50vh; }
        .skyline-depth.depth-front { opacity: 0.45; top: 0; bottom: 0; }
        .skyline-depth.depth-front img { height: 100%; }

        .interior-title {
            font-family: 'Poiret One', cursive;
            font-size: 18px; color: var(--gold);
            letter-spacing: 4px; margin-bottom: 6px;
            text-align: center; z-index: 10;
        }
        .interior-subtitle {
            font-size: 10px; color: rgba(201,168,76,0.5);
            letter-spacing: 2px; margin-bottom: 15px;
            text-align: center; z-index: 10;
        }
        .iso-floor {
            position: relative;
            width: 750px; height: 750px;
            transform: rotateX(60deg) rotateZ(45deg);
            transform-style: preserve-3d;
            flex-shrink: 0;
            z-index: 5;
        }
        .floor-surface {
            position: absolute; inset: 0;
            background:
                repeating-linear-gradient(90deg, rgba(201,168,76,0.05) 0px, rgba(201,168,76,0.05) 1px, transparent 1px, transparent 75px),
                repeating-linear-gradient(0deg, rgba(201,168,76,0.05) 0px, rgba(201,168,76,0.05) 1px, transparent 1px, transparent 75px),
                var(--dark-gray);
            border: 3px solid var(--gold);
            box-shadow: 0 40px 80px rgba(0,0,0,0.8);
        }
        .room {
            position: absolute;
            border: 2px solid var(--gold);
            background: var(--medium-gray);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }
        .room:hover {
            transform: translateZ(8px);
            box-shadow: 0 0 20px rgba(201,168,76,0.4);
        }

        /* Room background images from ComfyUI */
        .room .room-bg {
            position: absolute; inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.85;
            z-index: 0;
        }
        .room .room-content {
            position: relative; z-index: 15;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            width: 100%; height: 100%;
            transform: translateZ(20px); /* lift labels above 3D sprite panels */
        }

        .office {
            width: 200px; height: 200px;
            overflow: visible;  /* allow panel to project above the floor */
        }
        .off-tl { top: 20px; left: 20px; border-color: var(--red); }
        .off-tr { top: 20px; right: 20px; border-color: var(--gold); }
        .off-bl { bottom: 20px; left: 20px; border-color: var(--blue); }
        .off-br { bottom: 20px; right: 20px; border-color: var(--green); }

        /* ========== PERPENDICULAR PANELS (standing upright inside floor squares) ========== */
        /* Counter-rotate to stand upright against the isometric floor transform */
        .room-panel {
            position: absolute;
            top: 50%; left: 50%;
            width: 0; height: 0;
            z-index: 10;
            transform-style: preserve-3d;
            pointer-events: none;
        }
        .room-panel img {
            position: absolute;
            bottom: 0;
            transform-origin: 50% 100%;
            transform: translate(-50%, 0) rotateZ(-45deg) rotateX(-60deg);
            filter: drop-shadow(0 4px 12px rgba(0,0,0,0.5));
            opacity: 0.9;
            transition: opacity 0.3s;
        }
        /* Office panels: 168px wide (Kevin baseline +5%), centered in 200px square */
        .office .room-panel img {
            width: 168px; height: auto;
        }
        /* Cubicle panels: 110px wide, centered in 140px square */
        .cubicle .room-panel img {
            width: 110px; height: auto;
        }
        .room:hover .room-panel img {
            opacity: 1;
            filter: drop-shadow(0 6px 18px rgba(201,168,76,0.3));
        }

        /* Cubicles: flat on floor (selection targets), sprites stand upright via room-panel */
        .cubicle {
            width: 140px; height: 140px;
            background: rgba(26,26,26,0.95);
            transform: scale(0.82);
            overflow: visible; /* allow room-panel sprites to project upright above the floor */
        }
        .cubicle:hover {
            transform: scale(0.82) translateZ(8px);
            box-shadow: 0 0 20px rgba(201,168,76,0.4);
        }
        /* AriBot = blue (Ari's Agent) — near Ari (bottom-left) */
        .cub-1 { top: 430px; left: 180px; border-color: var(--blue); }
        /* SBot = red (Security) — center midpoint */
        .cub-2 { top: 305px; left: 305px; border-color: var(--red); }
        /* EdBot = green (Editing) — near Kevin (top-right) */
        .cub-3 { top: 180px; left: 430px; border-color: var(--green); }
        .room-accent {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 4px; z-index: 2;
        }
        .off-tl .room-accent { background: var(--red); }
        .off-tr .room-accent { background: var(--gold); }
        .off-bl .room-accent { background: var(--blue); }
        .off-br .room-accent { background: var(--green); }
        .room-name {
            font-family: 'Poiret One', cursive;
            font-size: 15px; font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8), 0 0 12px rgba(0,0,0,1);
            background: rgba(5,5,5,0.7);
            padding: 1px 8px;
            border-radius: 2px;
        }
        .room-role {
            font-size: 9px; color: var(--gold);
            letter-spacing: 1px; margin-top: 2px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        }
        .cub-tier {
            display: inline-block;
            background: var(--gold); color: var(--black);
            font-size: 8px; font-weight: 700;
            padding: 2px 6px; margin-top: 5px;
            letter-spacing: 1px;
        }
        /* Data tubes — flat on floor between connected rooms */
        .data-tube {
            position: absolute;
            z-index: 3;
            opacity: 0.6;
            width: 120px;
            pointer-events: none;
            transition: opacity 0.4s ease, filter 0.4s ease;
        }
        .data-tube.active {
            opacity: 1;
            filter: brightness(1.4) drop-shadow(0 0 8px rgba(201,168,76,0.6));
        }

        /* Human review overlay sprites — counter-rotated to stand upright on iso floor */
        .review-overlay-sprite {
            position: absolute;
            z-index: 25;
            transform: rotateZ(-45deg) rotateX(-60deg);
            opacity: 0;
            transition: opacity 0.6s ease;
            pointer-events: none;
            width: 100px;
            height: auto;
        }
        .review-overlay-sprite.visible {
            opacity: 1;
        }

        .gov-svg {
            position: absolute; inset: 0;
            pointer-events: none; z-index: 2;
        }
        .spawn-line {
            stroke-dasharray: 6 4;
            opacity: 0.25;
            animation: marchDash 2s linear infinite;
        }
        @keyframes marchDash { to { stroke-dashoffset: -20; } }
        @keyframes flywheelSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* ========== OFFICE ZOOM VIEW ========== */
        #officeZoom {
            position: fixed; inset: 0;
            /* Background set dynamically per-office via JS */
            background-color: #0d0b08;
            background-size: contain;
            background-position: center center;
            background-repeat: no-repeat;
            z-index: 500;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 30px;
        }
        #officeZoom::before {
            content: '';
            position: absolute; inset: 0;
            background: radial-gradient(ellipse at 50% 50%, transparent 40%, rgba(0,0,0,0.6) 100%);
            pointer-events: none; z-index: 0;
        }
        #officeZoom::after {
            content: '';
            position: absolute; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(201,168,76,0.02) 3px, rgba(201,168,76,0.02) 4px);
            pointer-events: none; z-index: 0;
        }
        #officeZoom.active { display: flex; }

        .zoom-close {
            position: absolute; top: 20px; left: 30px;
            background: rgba(10,10,10,0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-family: 'Poiret One', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            padding: 8px 20px;
            cursor: pointer; z-index: 510;
            transition: background 0.2s, color 0.2s;
        }
        .zoom-close:hover {
            background: var(--gold);
            color: var(--black);
        }
        .zoom-title {
            font-family: 'Poiret One', cursive;
            font-size: 22px; color: var(--gold);
            letter-spacing: 3px; margin-bottom: 15px;
            z-index: 1; position: relative;
        }

        /* Desk scene — fills office zoom viewport */
        .desk-scene {
            position: relative;
            width: 100%;
            height: calc(100vh - 80px);
            z-index: 1;
            margin-top: auto;
            margin-bottom: 0;
        }
        .figure-col {
            position: absolute; bottom: 20px;
            display: flex; flex-direction: column;
            align-items: center; z-index: 5;
        }
        .figure-col.figure-left { left: 80px; }
        .figure-col.figure-right { right: 80px; }
        .figure-col.figure-center-right { right: 30%; }
        .figure-col.figure-center { left: 50%; transform: translateX(-50%); }
        .desk-surface {
            position: absolute; bottom: 20px;
            left: 50%; transform: translateX(-50%);
            z-index: 2;
            display: flex; flex-direction: column;
            align-items: center; justify-content: flex-end;
        }
        .desk-surface.desk-right {
            left: auto; right: 25%;
            transform: none;
        }
        .desk-surface img.desk-img {
            width: 280px; height: auto;
            object-fit: contain;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.6));
        }
        .desk-computer {
            width: 70px; height: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 8px rgba(201,168,76,0.3));
            z-index: 3;
        }

        /* Sprite figure container — tall to hold full body, parent clips it */
        .sprite-figure {
            position: relative;
            width: 240px; height: 360px;
            display: flex; align-items: flex-start; justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            order: 2;    /* flex order: after buttons and label */
        }
        .sprite-figure:hover { filter: brightness(1.2); }
        .sprite-figure img {
            width: 240px; height: 340px;
            position: relative; z-index: 1;
            object-fit: contain;
        }
        /* Fallback when ComfyUI images haven't been generated yet */
        .sprite-figure img[src=""],
        .sprite-figure img:not([src]),
        .sprite-figure img.placeholder {
            background: linear-gradient(135deg, var(--dark-gray), var(--medium-gray));
            border: 2px dashed rgba(201,168,76,0.3);
            border-radius: 8px;
            min-width: 200px; min-height: 280px;
        }
        .brain-q img[src=""],
        .brain-q img:not([src]) {
            background: linear-gradient(135deg, #1a1520, #2d2d2d);
            border: 2px dashed rgba(201,168,76,0.3);
            border-radius: 0;
        }

        /* Holographic agent glow */
        .agent-figure {
            --glow-color: var(--gold);
        }
        .agent-figure::before {
            content: '';
            position: absolute; inset: -10px;
            background: radial-gradient(ellipse, var(--glow-color, var(--gold)) 0%, transparent 60%);
            opacity: 0.15;
            animation: holoFlicker 4s ease-in-out infinite;
            border-radius: 50%;
        }
        .agent-figure .scan-lines {
            position: absolute; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(201,168,76,0.06) 3px, rgba(201,168,76,0.06) 4px);
            pointer-events: none; z-index: 2; mix-blend-mode: screen;
        }
        .agent-figure img {
            filter: drop-shadow(0 0 12px var(--glow-color, var(--gold))) drop-shadow(0 0 25px rgba(201,168,76,0.3));
        }
        @keyframes holoFlicker {
            0%, 100% { opacity: 0.1; }
            50% { opacity: 0.2; }
        }

        .col-label {
            font-family: 'Poiret One', cursive;
            font-size: 16px; font-weight: bold;
            letter-spacing: 3px;
            text-shadow: 0 2px 10px rgba(0,0,0,1), 0 0 20px rgba(0,0,0,0.8);
            z-index: 100;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.8;
            transition: opacity 0.2s ease;
            pointer-events: none;
            white-space: nowrap;
            padding: 3px 12px 4px;
            background: rgba(5,5,5,0.85);
            border-radius: 2px;
            border-bottom: 1px solid rgba(201,168,76,0.25);
        }
        .figure-col:hover > .col-label { opacity: 1; }
        .col-label.human { color: var(--cream); }
        .col-label.agent { color: var(--gold); }

        /* Agent side — hidden until activated */
        .agent-col { opacity: 0; transition: opacity 0.8s ease; }
        .agent-col.active { opacity: 1; }

        /* Bot status bar — DORMANT → INITIALIZING → OPERATIONAL */
        .bot-status-bar {
            display: flex; align-items: center; gap: 6px;
            margin-top: 6px; margin-bottom: 2px;
            font-family: 'Space Mono', monospace;
            font-size: 9px; letter-spacing: 1px;
        }
        .bot-status-bar .status-segments {
            display: flex; gap: 2px;
        }
        .bot-status-bar .status-seg {
            width: 18px; height: 6px;
            background: rgba(201,168,76,0.15);
            border: 1px solid rgba(201,168,76,0.2);
            transition: background 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }
        .bot-status-bar .status-seg.filled {
            background: var(--gold);
            border-color: var(--gold);
            box-shadow: 0 0 4px rgba(201,168,76,0.5);
        }
        .bot-status-bar .status-seg.filled.green {
            background: var(--green);
            border-color: var(--green);
            box-shadow: 0 0 6px rgba(42,157,143,0.6);
        }
        .bot-status-bar .status-label {
            color: rgba(201,168,76,0.5);
            transition: color 0.4s ease;
        }
        .bot-status-bar .status-label.active {
            color: var(--green);
            text-shadow: 0 0 6px rgba(42,157,143,0.4);
        }

        .holo-pedestal {
            width: 80px; height: 6px;
            background: radial-gradient(ellipse, rgba(201,168,76,0.3) 0%, transparent 70%);
            margin-top: 4px;
        }

        /* ========== HOVER TOOLTIP TEXT BOXES ========== */
        [data-tooltip] {
            position: relative;
        }
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(5,5,5,0.95);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 5px 14px;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            letter-spacing: 1px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 100;
            text-shadow: 0 0 8px rgba(201,168,76,0.4);
        }
        /* Move tooltips below sprite when inside figure-col to avoid overlapping the name label above */
        .figure-col [data-tooltip]:hover::after {
            top: auto;
            bottom: -28px;
        }

        /* Computer glow on hover in Ari's office */
        .computer-hoverable:hover {
            filter: drop-shadow(0 8px 25px rgba(201,168,76,0.6)) brightness(1.3) !important;
        }

        /* Hologram materialization effect */
        @keyframes holoMaterialize {
            0%   { opacity: 0; filter: brightness(3) blur(10px); transform: scaleY(0.1); }
            30%  { opacity: 0.5; filter: brightness(2) blur(5px); transform: scaleY(0.6); }
            60%  { opacity: 0.8; filter: brightness(1.5) blur(2px); transform: scaleY(0.9); }
            100% { opacity: 1; filter: brightness(1) blur(0); transform: scaleY(1); }
        }
        .holo-materialize {
            animation: holoMaterialize 1.2s ease-out forwards;
        }

        /* ========== ARI 4-SLOT OFFICE LAYOUT ========== */
        .ari-slot-human { left: 8% !important; }
        .ari-slot-computer {
            left: 32% !important;
            transform: translateX(-50%) !important;
        }
        .ari-slot-aribot {
            left: 54% !important;
            right: auto !important;
        }
        .ari-slot-farright {
            left: 76% !important;
            right: auto !important;
        }

        /* ========== BRAIN SPLIT-SCREEN VIEW ========== */
        .brain-overlay {
            position: fixed; inset: 0;
            z-index: 700;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .brain-overlay.active { display: flex; }
        .brain-backdrop {
            position: absolute; inset: 0;
            background: rgba(5, 5, 5, 0.96);
        }
        .brain-content {
            position: relative;
            z-index: 1;
            width: 95vw; max-width: 1200px;
            max-height: 92vh;
            display: flex; flex-direction: column;
            align-items: center;
            overflow-y: auto;
            padding: 24px 0 16px;
        }
        .brain-header {
            text-align: center; margin-bottom: 6px;
        }
        .brain-header-title {
            font-family: 'Poiret One', cursive;
            font-size: 22px; color: var(--gold);
            letter-spacing: 3px;
        }
        .brain-header-subtitle {
            font-size: 9px; color: rgba(201,168,76,0.5);
            letter-spacing: 2px; margin-top: 4px;
        }
        .brain-close-btn {
            position: absolute; top: 16px; left: 24px;
            background: rgba(10,10,10,0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-family: 'Poiret One', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            padding: 8px 20px;
            cursor: pointer; z-index: 5;
            transition: background 0.2s, color 0.2s;
        }
        .brain-close-btn:hover {
            background: var(--gold);
            color: var(--black);
        }

        /* Dossier tabs — Carmen San Diego folder tabs */
        .bot-dossier-tabs {
            display: flex; gap: 0; margin-bottom: 14px;
        }
        .dossier-tab {
            background: rgba(10,10,10,0.6);
            border: 1px solid rgba(201,168,76,0.15);
            border-bottom: 3px solid transparent;
            color: rgba(201,168,76,0.35);
            font-family: 'Poiret One', cursive;
            font-size: 12px; letter-spacing: 2px;
            padding: 8px 18px 6px;
            cursor: pointer;
            display: flex; flex-direction: column;
            align-items: center; gap: 2px;
        }
        .dossier-tab:first-child { border-radius: 4px 0 0 0; }
        .dossier-tab:last-child { border-radius: 0 4px 0 0; }
        .dossier-tab .tab-role {
            font-family: 'Space Mono', monospace;
            font-size: 7px; letter-spacing: 1px;
            opacity: 0.6;
        }
        .dossier-tab.active {
            background: rgba(201,168,76,0.08);
            border-color: var(--gold);
            color: var(--gold);
        }
        .dossier-tab:hover:not(.active) {
            border-color: rgba(201,168,76,0.3);
            color: rgba(201,168,76,0.6);
        }

        /* Split layout */
        .brain-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            width: 100%;
            margin-bottom: 14px;
        }

        /* Left: Our brain */
        .brain-ours {
            display: flex; flex-direction: column;
            align-items: center;
        }
        .bot-descriptor {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 12px; color: var(--cream);
            line-height: 1.6;
            text-align: center;
            max-width: 420px;
            margin-top: 12px;
            margin-bottom: 0;
            opacity: 0.8;
        }
        /* Brain diamond quadrants */
        .brain-quadrants {
            position: relative;
            width: 530px; height: 530px;
            flex-shrink: 0;
        }
        .brain-q {
            position: absolute;
            width: 196px; height: 196px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border: none;
            background: rgba(10,10,10,0.7);
            border-radius: 6px;
            cursor: pointer;
            gap: 4px;
        }
        .brain-q:hover {
            background: rgba(201,168,76,0.06);
        }
        .brain-q img {
            width: 98px; height: 98px;
            object-fit: contain;
            border-radius: 0;
        }
        .brain-q-label {
            font-family: 'Poiret One', cursive;
            font-size: 11px; letter-spacing: 1px;
            text-align: center;
        }
        .brain-q-sublabel {
            font-family: 'Space Mono', monospace;
            font-size: 7px; opacity: 0.5;
            text-align: center;
            max-width: 120px;
        }
        /* Diamond positions: top, left, right, bottom */
        .brain-q-claude    { top: 0; left: 50%; transform: translateX(-50%); }
        .brain-q-goose     { top: 50%; left: 0; transform: translateY(-50%); }
        .brain-q-ollama    { top: 50%; right: 0; transform: translateY(-50%); }
        .brain-q-anythingllm { bottom: 0; left: 50%; transform: translateX(-50%); }
        .brain-q-claude .brain-q-label { color: var(--blue); }
        .brain-q-goose .brain-q-label { color: var(--green); }
        .brain-q-ollama .brain-q-label { color: var(--yellow); }
        .brain-q-anythingllm .brain-q-label { color: #b080d0; }
        /* Brain quadrant tooltip */
        .brain-q-tooltip {
            position: absolute;
            bottom: -20px; left: 50%;
            transform: translateX(-50%);
            background: none;
            border: none;
            color: var(--gold);
            font-family: 'Space Mono', monospace;
            font-size: 9px;
            letter-spacing: 1px;
            padding: 0;
            white-space: nowrap;
            pointer-events: none;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .brain-q:hover .brain-q-tooltip {
            opacity: 0.6;
        }
        /* SVG connections in diamond */
        .brain-q-connections {
            position: absolute; inset: 0;
            pointer-events: none;
        }
        .brain-q-connections line {
            stroke: var(--gold); stroke-width: 1;
            stroke-dasharray: 4 4; opacity: 0.2;
            animation: marchDash 2s linear infinite;
        }

        /* Right: ClawdBot panel */
        .brain-theirs {
            display: flex; flex-direction: column;
            align-items: center;
        }
        .clawdbot-portrait {
            width: 120px; height: 120px;
            margin-bottom: 12px;
            opacity: 0.85;
        }
        .clawdbot-portrait svg, .clawdbot-portrait img { width: 100%; height: 100%; object-fit: contain; }
        .clawdbot-label {
            font-family: 'Poiret One', cursive;
            font-size: 16px; color: var(--red);
            letter-spacing: 3px; margin-bottom: 8px;
        }
        .vuln-panel {
            background: rgba(20,10,10,0.6);
            border: 1px solid rgba(230,57,70,0.3);
            border-radius: 4px;
            padding: 16px;
            width: 100%;
            max-width: 460px;
        }
        .vuln-title {
            font-family: 'Poiret One', cursive;
            font-size: 14px; color: var(--red);
            letter-spacing: 2px; margin-bottom: 8px;
        }
        .vuln-body {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 11px; color: rgba(245,230,200,0.7);
            line-height: 1.7;
        }
        .vuln-body strong { color: var(--red); }
        .vuln-stat {
            font-family: 'Space Mono', monospace;
            font-size: 10px; color: var(--red);
            opacity: 0.8; margin-top: 6px;
        }

        /* ========== SCHEMATIC OVERLAY (over brain) ========== */
        #schematicOverlay {
            position: fixed; inset: 0;
            z-index: 750;
            display: none;
            align-items: center;
            justify-content: center;
        }
        #schematicOverlay.active { display: flex; }
        .schematic-backdrop {
            position: absolute; inset: 0;
            background: rgba(5,5,5,0.94);
        }
        .schematic-panel {
            position: relative; z-index: 1;
            width: 90vw; max-width: 900px;
            max-height: 92vh;
            overflow-y: auto;
            padding: 20px;
            background: rgba(10,10,10,0.95);
            border: 1px solid rgba(201,168,76,0.3);
            border-radius: 6px;
        }
        .schematic-close {
            position: absolute; top: 12px; left: 16px;
            background: rgba(10,10,10,0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-family: 'Poiret One', cursive;
            font-size: 14px;
            letter-spacing: 2px;
            padding: 6px 16px;
            cursor: pointer; z-index: 2;
            transition: background 0.2s, color 0.2s;
        }
        .schematic-close:hover {
            background: var(--gold);
            color: var(--black);
        }
        .schematic-header-img {
            max-height: 180px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .schematic-two-col {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 16px;
            align-items: start;
        }
        .schematic-icon-col {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .schematic-icon-col .schematic-header-img {
            max-height: 180px;
            width: 100%;
        }
        .schematic-title {
            font-family: 'Poiret One', cursive;
            font-size: 16px; letter-spacing: 3px;
            margin-bottom: 8px;
            text-align: center;
        }

        /* Claude schematic: cost split */
        .claude-cost-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .claude-cost-col {
            display: flex; flex-direction: column;
            gap: 10px;
        }
        .claude-cost-col img {
            width: 100%; max-height: 120px;
            object-fit: contain;
            border-radius: 4px;
        }
        .claude-cost-printout {
            background: rgba(10,10,10,0.9);
            border: 1px solid var(--gold);
            border-radius: 4px;
            padding: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 10px; color: var(--gold);
            line-height: 1.8;
        }
        .claude-burning-tokens {
            background: rgba(20,8,8,0.9);
            border: 1px solid rgba(230,57,70,0.4);
            border-radius: 4px;
            padding: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 10px; color: var(--red);
            line-height: 1.8;
        }
        .claude-burning-tokens .burn-quote {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 11px; color: rgba(230,57,70,0.7);
            font-style: italic;
            margin-top: 8px;
            line-height: 1.6;
        }

        /* Ollama schematic: model picker + GPU tiers */
        .ollama-split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .model-picker {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .model-option {
            border: 1.5px solid rgba(201,168,76,0.2);
            background: rgba(10,10,10,0.8);
            border-radius: 4px;
            padding: 7px;
            cursor: pointer;
            text-align: center;
        }
        .model-option:hover { border-color: rgba(201,168,76,0.5); }
        .model-option.disabled-model {
            opacity: 0.25;
            filter: grayscale(1);
            pointer-events: none;
        }
        .model-option.active-model {
            border-color: var(--yellow);
            background: rgba(241,184,68,0.08);
            box-shadow: 0 0 12px rgba(241,184,68,0.2);
        }
        .model-option .model-name {
            font-family: 'Poiret One', cursive;
            font-size: 12px; color: var(--cream);
            letter-spacing: 1px; margin-bottom: 4px;
        }
        .model-option .model-size {
            font-family: 'Space Mono', monospace;
            font-size: 9px; color: var(--yellow);
            opacity: 0.7;
        }
        .gpu-tier-menu {
            display: flex; flex-direction: column;
            gap: 6px;
        }
        .gpu-tier-row {
            display: grid;
            grid-template-columns: 60px 100px 1fr;
            gap: 8px;
            padding: 5px 8px;
            border: 1px solid rgba(201,168,76,0.1);
            border-radius: 3px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-size: 9px;
            align-items: center;
        }
        .gpu-tier-row:hover { border-color: rgba(201,168,76,0.3); background: rgba(201,168,76,0.03); }
        .gpu-tier-row.active-tier {
            border-color: var(--gold);
            background: rgba(201,168,76,0.06);
        }
        .gpu-tier-row .tier-vram { color: var(--gold); font-weight: 700; }
        .gpu-tier-row .tier-gpu { color: var(--cream); }
        .gpu-tier-row .tier-models { color: rgba(201,168,76,0.5); font-size: 9px; }
        .llm-stats-tooltip {
            position: absolute;
            background: rgba(10,10,10,0.95);
            border: 1px solid var(--gold);
            border-radius: 4px;
            padding: 10px 14px;
            font-family: 'Space Mono', monospace;
            font-size: 9px; color: var(--cream);
            line-height: 1.8;
            z-index: 800;
            pointer-events: none;
            white-space: nowrap;
        }

        /* AnythingLLM schematic: memory cards */
        .memory-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
            margin-bottom: 14px;
        }
        .memory-type-card {
            border: 1px solid rgba(176,128,208,0.3);
            background: rgba(10,10,10,0.8);
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }
        .memory-type-card:hover { border-color: #b080d0; }
        .memory-type-card .mem-title {
            font-family: 'Poiret One', cursive;
            font-size: 11px; color: #b080d0;
            letter-spacing: 1px; margin-bottom: 4px;
        }
        .memory-type-card .mem-summary {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 9px; color: var(--cream);
            opacity: 0.7; line-height: 1.5;
        }
        .memory-type-card .mem-detail {
            display: none;
            font-family: 'Space Mono', monospace;
            font-size: 9px; color: rgba(176,128,208,0.7);
            line-height: 1.7;
            margin-top: 8px;
            text-align: left;
            border-top: 1px solid rgba(176,128,208,0.15);
            padding-top: 8px;
        }
        .memory-type-card.expanded .mem-detail { display: block; }
        .memory-type-card .mem-expand-img {
            width: 100%; max-height: 80px;
            object-fit: contain;
            margin-top: 8px;
            border-radius: 3px;
            opacity: 0.7;
        }

        /* Goose schematic: MCP cards + local tools */
        .mcp-server-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 14px;
        }
        .mcp-server-card {
            border: 1px solid rgba(42,157,143,0.3);
            background: rgba(10,10,10,0.8);
            border-radius: 4px;
            padding: 8px;
            display: flex; gap: 10px;
            align-items: flex-start;
        }
        .mcp-server-card .mcp-icon {
            width: 32px; height: 32px;
            object-fit: contain;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .mcp-server-card .mcp-info {
            flex: 1;
        }
        .mcp-server-card .mcp-name {
            font-family: 'Poiret One', cursive;
            font-size: 11px; color: var(--green);
            letter-spacing: 1px;
        }
        .mcp-server-card .mcp-transport {
            font-family: 'Space Mono', monospace;
            font-size: 8px; color: rgba(42,157,143,0.5);
            letter-spacing: 0.5px;
        }
        .mcp-server-card .mcp-tools {
            font-family: 'Space Mono', monospace;
            font-size: 8px; color: var(--cream);
            opacity: 0.6; margin-top: 4px;
            line-height: 1.5;
        }
        .mcp-server-card .mcp-status {
            font-family: 'Space Mono', monospace;
            font-size: 8px; margin-top: 4px;
        }
        .mcp-status.active { color: var(--green); }
        .mcp-status.planned { color: var(--yellow); }
        .local-tools-list {
            border-top: 1px solid rgba(201,168,76,0.1);
            padding-top: 10px;
            margin-top: 6px;
        }
        .local-tools-list .lt-title {
            font-family: 'Poiret One', cursive;
            font-size: 12px; color: var(--gold);
            letter-spacing: 1px; margin-bottom: 6px;
        }
        .local-tools-list .lt-items {
            display: flex; flex-wrap: wrap; gap: 6px;
        }
        .local-tools-list .lt-item {
            font-family: 'Space Mono', monospace;
            font-size: 9px; color: var(--cream);
            opacity: 0.6;
            background: rgba(201,168,76,0.05);
            border: 1px solid rgba(201,168,76,0.1);
            padding: 3px 8px;
            border-radius: 3px;
        }

        /* Price badges */
        .brain-price-row {
            display: flex; gap: 20px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .price-badge {
            font-family: 'Space Mono', monospace;
            font-size: 13px; font-weight: 700;
            letter-spacing: 1px;
            padding: 8px 20px;
            border: 2px solid;
            border-radius: 2px;
            text-align: center;
        }
        .price-badge.ours {
            color: var(--green);
            border-color: var(--green);
            background: rgba(42,157,143,0.08);
        }
        .price-badge.theirs {
            color: var(--red);
            border-color: var(--red);
            background: rgba(230,57,70,0.08);
        }

        /* Ownership bar */
        .ownership-bar-wrap {
            width: 100%;
            max-width: 800px;
            margin-top: 6px;
        }
        .ownership-bar {
            height: 32px;
            border-radius: 3px;
            display: flex;
            overflow: hidden;
            border: 1px solid rgba(201,168,76,0.2);
        }
        .ownership-bar .own-local {
            background: linear-gradient(90deg, var(--green), rgba(42,157,143,0.6));
            display: flex; align-items: center; justify-content: center;
            font-family: 'Space Mono', monospace;
            font-size: 8px; color: #fff;
            letter-spacing: 0.5px;
            padding: 0 8px;
            white-space: nowrap;
            overflow: hidden;
        }
        .ownership-bar .own-cloud {
            background: linear-gradient(90deg, rgba(230,57,70,0.4), rgba(230,57,70,0.7));
            display: flex; align-items: center; justify-content: center;
            font-family: 'Space Mono', monospace;
            font-size: 8px; color: rgba(255,255,255,0.8);
            letter-spacing: 0.5px;
            padding: 0 8px;
            white-space: nowrap;
            overflow: hidden;
        }
        .ownership-labels {
            display: flex; justify-content: space-between;
            margin-top: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 8px; color: rgba(201,168,76,0.4);
            letter-spacing: 0.5px;
        }

        /* ========== P2: FLYWHEEL BRAIN — Claude→Local Handoff ========== */
        .flywheel-view {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; width: 100%; max-width: 700px;
        }
        .flywheel-title {
            font-family: 'Poiret One', cursive;
            font-size: 20px; color: var(--gold);
            letter-spacing: 3px; text-align: center;
        }
        .flywheel-nodes {
            position: relative; width: 500px; height: 300px;
        }
        .flywheel-node {
            position: absolute; display: flex; flex-direction: column;
            align-items: center; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .flywheel-orb {
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-family: 'Space Mono', monospace; font-size: 9px; color: #fff;
            text-align: center; transition: all 0.6s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden; background: rgba(10,10,10,0.8);
            cursor: pointer;
        }
        .flywheel-orb img {
            width: 100%; height: 100%;
            object-fit: contain;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .flywheel-orb:hover {
            box-shadow: 0 0 30px rgba(201,168,76,0.5);
            transform: scale(1.1);
        }
        .flywheel-node-label {
            font-family: 'Poiret One', cursive; font-size: 11px;
            letter-spacing: 1px; margin-top: 6px; white-space: nowrap;
        }
        .flywheel-node-cost {
            font-family: 'Space Mono', monospace; font-size: 9px;
            opacity: 0.7; margin-top: 2px;
        }
        /* Connection lines between flywheel nodes */
        .flywheel-connections line {
            stroke: var(--gold); stroke-width: 1.5;
            stroke-dasharray: 4 4; opacity: 0.3;
            animation: marchDash 2s linear infinite;
            transition: stroke-width 0.6s ease;
        }
        .flywheel-slider-wrap {
            width: 100%; max-width: 500px; text-align: center;
        }
        .flywheel-slider {
            width: 100%; appearance: none; -webkit-appearance: none;
            height: 6px; border-radius: 3px;
            background: linear-gradient(90deg, var(--blue), var(--green));
            outline: none; cursor: pointer;
        }
        .flywheel-slider::-webkit-slider-thumb {
            appearance: none; -webkit-appearance: none;
            width: 20px; height: 20px; border-radius: 50%;
            background: var(--gold); border: 2px solid var(--black);
            cursor: grab; box-shadow: 0 0 8px rgba(201,168,76,0.5);
        }
        .flywheel-slider-labels {
            display: flex; justify-content: space-between;
            font-family: 'Space Mono', monospace; font-size: 9px;
            color: var(--gold); opacity: 0.6; margin-top: 4px;
        }
        .flywheel-narrative {
            font-size: 12px; color: var(--cream); line-height: 1.8;
            text-align: center; max-width: 500px; min-height: 60px;
            transition: opacity 0.3s ease;
        }

        /* ========== TOWER PC ========== */
        .tower-pc {
            position: absolute;
            bottom: 80px; left: 50%; transform: translateX(-50%) translateX(140px);
            z-index: 1;
            display: flex; flex-direction: column; align-items: center;
        }
        .tower-pc .pc-body {
            width: 50px; height: 90px;
            background: linear-gradient(135deg, #1a1a1a, #2a2520);
            border: 2px solid var(--gold);
            border-radius: 3px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 0 20px rgba(201,168,76,0.05);
        }
        .tower-pc .pc-vent {
            position: absolute; top: 8px; left: 8px; right: 8px;
            height: 20px;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(201,168,76,0.15) 2px, rgba(201,168,76,0.15) 3px);
        }
        .tower-pc .pc-drive {
            position: absolute; top: 35px; left: 8px; right: 8px;
            height: 8px;
            background: #111; border: 1px solid rgba(201,168,76,0.3);
        }
        .tower-pc .pc-led {
            position: absolute; bottom: 10px; left: 12px;
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 6px var(--green);
            animation: ledBlink 2s ease-in-out infinite;
        }
        .tower-pc .pc-led.processing {
            background: var(--yellow);
            box-shadow: 0 0 6px var(--yellow);
            animation: ledFast 0.4s ease-in-out infinite;
        }
        @keyframes ledBlink { 0%,100% { opacity: 0.4; } 50% { opacity: 1; } }
        @keyframes ledFast { 0%,100% { opacity: 0.3; } 50% { opacity: 1; } }
        .tower-pc .pc-label {
            font-family: 'Space Mono', monospace;
            font-size: 7px; color: rgba(201,168,76,0.5);
            letter-spacing: 1px; margin-top: 3px;
        }

        /* ========== FLOATING TOY BUTTONS ========== */
        .fun-buttons {
            position: relative;
            display: flex; gap: 8px;
            z-index: 20;
            pointer-events: auto;
            order: 0;    /* flex order: buttons first, then label, then sprite */
            margin-bottom: 2px;
            justify-content: center;
        }
        .fun-btn {
            background: rgba(10,10,10,0.85);
            border: 1.5px solid var(--gold);
            color: var(--gold);
            padding: 4px 10px;
            font-family: 'Space Mono', monospace;
            font-size: 8px; letter-spacing: 0.5px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            animation: funFloat 3s ease-in-out infinite;
            position: relative;
        }
        .fun-btn:nth-child(2) { animation-delay: -1.5s; }
        .fun-btn:hover {
            background: var(--gold); color: var(--black);
            box-shadow: 0 0 12px rgba(201,168,76,0.5);
            transform: scale(1.08);
        }
        .fun-btn.pressed {
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s;
        }
        .fun-btn.spawning {
            transform: scale(0) translateY(10px);
            opacity: 0;
            animation: none;
        }
        .fun-btn.spawning.ready {
            transform: scale(1) translateY(0);
            opacity: 1;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: funFloat 3s ease-in-out infinite;
        }
        @keyframes funFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* ========== FUN ACTION ANIMATION OVERLAY ========== */
        .fun-action-overlay {
            position: absolute; inset: 0;
            display: flex; align-items: flex-start; justify-content: center;
            padding-top: 35%;
            pointer-events: none; z-index: 25;
            opacity: 0; transition: opacity 0.3s;
        }
        .fun-action-overlay.playing { opacity: 1; }
        .fun-action-text {
            font-family: 'Poiret One', cursive;
            font-size: 28px; color: var(--gold);
            letter-spacing: 4px;
            text-shadow: 0 0 20px rgba(201,168,76,0.6), 0 2px 10px rgba(0,0,0,0.8);
            animation: funActionPop 1.5s ease-out forwards;
        }
        @keyframes funActionPop {
            0% { transform: scale(0.5); opacity: 0; }
            20% { transform: scale(1.2); opacity: 1; }
            60% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1) translateY(-20px); opacity: 0; }
        }

        /* ========== STAGE LAYOUT ========== */
        .stage-frame { position: absolute; inset: 0; overflow: hidden; }
        .stage-content { position: absolute; inset: 0; z-index: 1; }

        /* Spotlight system — 3 CSS radial gradients */
        .spotlight {
            position: absolute; inset: 0; pointer-events: none; z-index: 50;
            opacity: 0; mix-blend-mode: screen;
        }
        .spotlight.warm {
            background: radial-gradient(ellipse 40% 60% at 50% 40%, rgba(201,168,76,0.08) 0%, transparent 100%);
        }
        .spotlight.cool {
            background: radial-gradient(ellipse 40% 60% at 50% 40%, rgba(69,123,157,0.08) 0%, transparent 100%);
        }
        .spotlight.accent {
            background: radial-gradient(ellipse 30% 50% at 50% 50%, rgba(230,57,70,0.06) 0%, transparent 100%);
        }

        /* Transition blackout overlay — dims lights between scenes */
        .transition-blackout {
            position: absolute; inset: 0; z-index: 300;
            background: rgba(0,0,0,0.92); pointer-events: none;
            opacity: 0;
        }
        /* Silhouette figures visible during blackout */
        .silhouette-row {
            position: absolute; bottom: 60px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 80px;
            z-index: 301; pointer-events: none; opacity: 0;
        }
        .silhouette-figure {
            width: 40px; height: 70px;
            background: #0a0a0a;
            border-radius: 20px 20px 4px 4px;
            position: relative;
            animation: silhouetteBreath 4s ease-in-out infinite;
        }
        .silhouette-figure:nth-child(2) { animation-delay: -1.3s; height: 65px; }
        .silhouette-figure:nth-child(3) { animation-delay: -2.6s; height: 75px; }
        @keyframes silhouetteBreath {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(-2px) scaleY(1.02); }
        }

        .page-title {
            position: fixed; top: 20px; left: 30px;
            font-family: 'Poiret One', cursive;
            font-size: 24px; color: var(--gold);
            letter-spacing: 2px; z-index: 1000;
            opacity: 0.9;
        }

        /* ========== COMPARISON OVERLAY ========== */
        .compare-overlay {
            position: fixed; inset: 0;
            background: rgba(5,5,5,0.97);
            z-index: 800;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        .compare-overlay.active { display: flex; }
        .compare-overlay-close {
            position: absolute; top: 20px; left: 30px;
            background: rgba(10,10,10,0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-family: 'Poiret One', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            padding: 8px 20px;
            cursor: pointer; z-index: 810;
            transition: background 0.2s, color 0.2s;
        }
        .compare-overlay-close:hover {
            background: var(--gold);
            color: var(--black);
        }
        .compare-title {
            font-family: 'Poiret One', cursive;
            font-size: 22px; color: var(--gold);
            letter-spacing: 4px; margin-bottom: 6px;
        }
        .compare-subtitle {
            font-size: 10px; color: rgba(201,168,76,0.5);
            letter-spacing: 2px; margin-bottom: 30px;
        }
        .compare-grid {
            display: grid;
            grid-template-columns: 1fr 60px 1fr;
            gap: 0;
            max-width: 800px; width: 100%;
        }
        .compare-header {
            font-family: 'Poiret One', cursive;
            font-size: 16px; letter-spacing: 2px;
            padding: 12px 16px;
            text-align: center;
        }
        .compare-header.good { color: var(--green); border-bottom: 2px solid var(--green); }
        .compare-header.vs { color: var(--gold); font-size: 12px; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 14px; }
        .compare-header.bad { color: var(--red); border-bottom: 2px solid var(--red); }
        .compare-row {
            display: contents;
        }
        .compare-cell {
            padding: 10px 16px;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 12px;
            line-height: 1.5;
            border-bottom: 1px solid rgba(201,168,76,0.1);
        }
        .compare-cell.good {
            color: var(--cream);
            text-align: right;
        }
        .compare-cell.vs {
            color: var(--gold);
            font-family: 'Space Mono', monospace;
            font-size: 9px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.4;
        }
        .compare-cell.bad {
            color: rgba(245,230,200,0.5);
            text-align: left;
        }
        .compare-footer {
            margin-top: 24px;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--gold);
            opacity: 0.5;
            letter-spacing: 1px;
        }

        /* ========== GPU / LOCAL LLM GUIDE OVERLAY ========== */
        #gpuGuideOverlay {
            position: fixed; inset: 0;
            background: rgba(5,5,5,0.95);
            backdrop-filter: blur(12px);
            z-index: 8000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        #gpuGuideOverlay.active { display: flex; }
        .gpu-guide-close {
            position: absolute; top: 20px; left: 30px;
            background: rgba(10,10,10,0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-family: 'Poiret One', cursive;
            font-size: 16px;
            letter-spacing: 2px;
            padding: 8px 20px;
            cursor: pointer; z-index: 1;
            transition: background 0.2s, color 0.2s;
        }
        .gpu-guide-close:hover {
            background: var(--gold);
            color: var(--black);
        }
        .gpu-guide-title {
            font-family: 'Poiret One', cursive;
            font-size: 28px; color: var(--gold);
            letter-spacing: 4px; margin-bottom: 8px;
        }
        .gpu-guide-subtitle {
            font-family: 'Space Mono', monospace;
            font-size: 10px; color: var(--gold);
            opacity: 0.5; letter-spacing: 1px;
            margin-bottom: 30px;
        }
        .gpu-guide-table {
            border-collapse: collapse;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
        }
        .gpu-guide-table th, .gpu-guide-table td {
            padding: 12px 20px;
            border: 1px solid rgba(201,168,76,0.2);
            text-align: left;
        }
        .gpu-guide-table th {
            color: var(--gold); font-weight: 700;
            background: var(--dark-gray);
            font-size: 11px; letter-spacing: 1px;
        }
        .gpu-guide-table td { color: var(--cream); }
        .gpu-guide-table tr:hover td { background: rgba(201,168,76,0.05); }
        .gpu-guide-table tr.gpu-highlight td {
            color: var(--gold);
            background: rgba(201,168,76,0.08);
            font-weight: 700;
        }
        .gpu-guide-footer {
            margin-top: 24px;
            text-align: center;
        }
        .gpu-note {
            font-family: 'Space Mono', monospace;
            font-size: 11px; color: var(--green);
            letter-spacing: 0.5px;
            margin-top: 6px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--black); }
        ::-webkit-scrollbar-thumb { background: var(--gold); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.14/dist/gsap.min.js"></script>
</head>
<body>
<div id="theater">
    <div id="stage">
        <div class="stage-frame" id="stageFrame">
            <!-- Spotlights -->
            <div class="spotlight warm" id="spotWarm"></div>
            <div class="spotlight cool" id="spotCool"></div>
            <div class="spotlight accent" id="spotAccent"></div>
            <!-- Transition blackout + silhouettes -->
            <div class="transition-blackout" id="transBlackout"></div>
            <div class="silhouette-row" id="silhouetteRow">
                <div class="silhouette-figure"></div>
                <div class="silhouette-figure"></div>
                <div class="silhouette-figure"></div>
            </div>
            <!-- Stage content -->
            <div class="stage-content">
                <svg width="0" height="0"><defs>
                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
                        <feColorMatrix in="blur" type="matrix" values="0 0 0 0 0.78 0 0 0 0 0.66 0 0 0 0 0.30 0 0 0 0.6 0" result="g"/>
                        <feMerge><feMergeNode in="g"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs></svg>
                <div class="page-title">AGILE LENS</div>

                <!-- VIEW 1: EXTERIOR -->
                <div id="exterior" class="view active">
                    <div class="city-scene" id="cityScene">
                        <div class="stars" id="stars"></div>
                        <!-- Skyline layers as exterior backdrop -->
                        <div style="position:absolute;top:0;bottom:0;left:0;right:0;display:flex;justify-content:center;align-items:flex-end;opacity:0.3;pointer-events:none;" id="extSkyBack"></div>
                        <div style="position:absolute;bottom:20%;left:0;right:0;display:flex;justify-content:center;align-items:flex-end;opacity:0.45;pointer-events:none;" id="extSkyMid"></div>
                        <div style="position:absolute;top:0;bottom:0;left:0;right:0;display:flex;justify-content:center;align-items:flex-end;opacity:0.6;pointer-events:none;" id="extSkyFront"></div>
                        <!-- Center skyline building — clickable entry point -->
                        <div class="hero-building" id="heroBuilding" onclick="drillDown()">
                            <img id="heroBuildingImg" alt="Agile Lens HQ" onerror="this.style.display='none'"/>
                            <div class="bldg-name" style="position:absolute;bottom:-32px;left:50%;transform:translateX(-50%);font-family:'Poiret One',cursive;font-size:14px;letter-spacing:2px;white-space:nowrap;color:var(--gold);font-weight:bold;">AGILE LENS</div>
                        </div>
                        <div class="ground"></div>
                        <div class="exterior-subtitle">THE PIPELINE CONTROL CENTER</div>
                        <div class="click-prompt">CLICK THE BUILDING TO ENTER</div>
                    </div>
                </div>

                <!-- VIEW 2: INTERIOR -->
                <div id="interior" class="view">
                    <!-- Skyline parallax layers behind the floor (multi-piece per depth) -->
                    <div class="skyline-wrap" id="skylineWrap">
                        <div class="skyline-depth depth-back" id="skyBack"></div>
                        <div class="skyline-depth depth-mid" id="skyMid"></div>
                        <div class="skyline-depth depth-front" id="skyFront"></div>
                    </div>

                    <div class="interior-title">AGILE LENS HQ</div>
                    <div class="interior-subtitle">CLICK AN OFFICE TO ZOOM IN &middot; CLICK A CUBICLE FOR DETAILS</div>
                    <button class="pipeline-run-btn" onclick="handlePipelineBtn()">&#9654; GO TO ARI'S OFFICE</button>
                    <div class="iso-floor">
                        <div class="floor-surface"></div>

                        <!-- Corner offices with background images -->
                        <div class="room office off-tl" data-agent="alex" data-zoom="true">
                            <div class="room-bg" id="roomBgAlex"></div>
                            <div class="room-accent"></div>
                            <div class="room-content">
                                <div class="room-name">ALEX</div>
                                <div class="room-role">CEO &middot; APPROVER</div>
                            </div>
                        </div>
                        <div class="room office off-tr" data-agent="kevin" data-zoom="true">
                            <div class="room-bg" id="roomBgKevin"></div>
                            <div class="room-accent"></div>
                            <div class="room-content">
                                <div class="room-name">KEVIN</div>
                                <div class="room-role">MEDIA PRODUCTION</div>
                            </div>
                        </div>
                        <div class="room office off-bl" data-agent="ari" data-zoom="true">
                            <div class="room-bg" id="roomBgAri"></div>
                            <div class="room-accent"></div>
                            <div class="room-content">
                                <div class="room-name">ARI</div>
                                <div class="room-role">AI AGENT DEV</div>
                            </div>
                        </div>
                        <div class="room office off-br" data-agent="henry" data-zoom="true">
                            <div class="room-bg" id="roomBgHenry"></div>
                            <div class="room-accent"></div>
                            <div class="room-content">
                                <div class="room-name">HENRY</div>
                                <div class="room-role">SECURITY &middot; NETWORK</div>
                            </div>
                        </div>

                        <!-- Center cubicles — 3 in a row, centered -->
                        <div class="room cubicle cub-1" data-agent="aribot">
                            <div class="room-bg" id="roomBgCub1"></div>
                            <div class="room-content">
                                <div class="room-name" style="font-size:12px">ARIBOT</div>
                                <div class="room-role">Ari's Agent</div>
                                <div class="cub-tier">T2</div>
                            </div>
                        </div>
                        <div class="room cubicle cub-2" data-agent="sbot">
                            <div class="room-bg" id="roomBgCub2"></div>
                            <div class="room-content">
                                <div class="room-name" style="font-size:12px">SBOT</div>
                                <div class="room-role">Security</div>
                                <div class="cub-tier">T4</div>
                            </div>
                        </div>
                        <div class="room cubicle cub-3" data-agent="edbot">
                            <div class="room-bg" id="roomBgCub3"></div>
                            <div class="room-content">
                                <div class="room-name" style="font-size:12px">EDBOT</div>
                                <div class="room-role">Editing</div>
                                <div class="cub-tier">T1</div>
                            </div>
                        </div>

                        <!-- Data tubes removed — cubicle action animations handle visual flow -->

                        <svg class="gov-svg" viewBox="0 0 750 750">
                            <defs>
                                <marker id="aG" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                    <polygon points="0 0,8 3,0 6" fill="#c9a84c" opacity="0.5"/>
                                </marker>
                            </defs>
                            <!-- Ari (off-bl) PROPOSES → Kevin (off-tr) -->
                            <line x1="220" y1="630" x2="600" y2="120" stroke="#c9a84c" stroke-width="1.5" opacity="0.3" marker-end="url(#aG)" stroke-dasharray="6 4"/>
                            <!-- Alex (off-tl) APPROVES → Kevin (off-tr) -->
                            <line x1="220" y1="120" x2="530" y2="120" stroke="#c9a84c" stroke-width="1.5" opacity="0.4" marker-end="url(#aG)" stroke-dasharray="6 4"/>
                            <rect x="330" y="96" width="90" height="16" rx="2" fill="rgba(10,10,10,0.7)"/>
                            <text x="375" y="110" fill="#c9a84c" font-size="11" opacity="0.6" text-anchor="middle" font-family="Josefin Sans">APPROVES</text>
                        </svg>
                    </div>
                    <!-- NO infoCard — DELETED -->
                </div>

                <!-- NO PIPELINE VIEW — DELETED -->

            </div><!-- /.stage-content -->
        </div><!-- /.stage-frame -->
    </div><!-- /#stage -->
    <div class="wing wing-left" id="wingLeft"></div>
    <div class="wing wing-right" id="wingRight"></div>
</div><!-- /#theater -->

<!-- OFFICE ZOOM OVERLAY -->
<div id="officeZoom">
    <button class="zoom-close" onclick="drillUp()">&larr; BACK</button>
    <div class="zoom-title" id="zoomTitle"></div>
    <div class="desk-scene" id="deskScene"></div>
    <!-- NO subagentRow — DELETED -->
</div>

<!-- BRAIN SPLIT-SCREEN OVERLAY -->
<div class="brain-overlay" id="brainOverlay">
    <div class="brain-backdrop" onclick="closeBrain()"></div>
    <div class="brain-content" onclick="event.stopPropagation()">
        <button class="brain-close-btn" onclick="closeBrain()">&larr; BACK</button>
        <div class="brain-header">
            <div class="brain-header-title" id="brainTitle">AGENT ARCHITECTURE</div>
            <div class="brain-header-subtitle" id="brainSubtitle">CLICK A QUADRANT TO EXAMINE &middot; SWITCH TABS TO COMPARE</div>
        </div>

        <!-- Dossier tabs -->
        <div class="bot-dossier-tabs" id="botDossierTabs"></div>

        <!-- Split view: our brain vs ClawdBot -->
        <div class="brain-split">
            <!-- LEFT: Our bot -->
            <div class="brain-ours">
                <div class="brain-quadrants" id="brainQuadrants">
                    <svg class="brain-q-connections" viewBox="0 0 530 530">
                        <line x1="265" y1="196" x2="196" y2="265"/>
                        <line x1="265" y1="196" x2="334" y2="265"/>
                        <line x1="196" y1="265" x2="265" y2="334"/>
                        <line x1="334" y1="265" x2="265" y2="334"/>
                        <line x1="196" y1="265" x2="334" y2="265"/>
                        <line x1="265" y1="196" x2="265" y2="334"/>
                    </svg>
                    <div class="brain-q brain-q-claude" onclick="clickQuadrant('claude')" onmouseenter="brainQHover(this,'claude')" onmouseleave="brainQUnhover(this,'claude')">
                        <div class="brain-q-tooltip">open</div>
                        <img id="bqClaudeImg" onerror="handleImgError(this)"/>
                        <div class="brain-q-label">CLAUDE CODE</div>
                        <div class="brain-q-sublabel" id="bqClaudeSub"></div>
                    </div>
                    <div class="brain-q brain-q-goose" onclick="clickQuadrant('goose')" onmouseenter="brainQHover(this,'goose')" onmouseleave="brainQUnhover(this,'goose')">
                        <div class="brain-q-tooltip">open</div>
                        <img id="bqGooseImg" onerror="handleImgError(this)"/>
                        <div class="brain-q-label">GOOSE CLI</div>
                        <div class="brain-q-sublabel" id="bqGooseSub"></div>
                    </div>
                    <div class="brain-q brain-q-ollama" onclick="clickQuadrant('ollama')" onmouseenter="brainQHover(this,'ollama')" onmouseleave="brainQUnhover(this,'ollama')">
                        <div class="brain-q-tooltip">open</div>
                        <img id="bqOllamaImg" onerror="handleImgError(this)"/>
                        <div class="brain-q-label">OLLAMA</div>
                        <div class="brain-q-sublabel" id="bqOllamaSub"></div>
                    </div>
                    <div class="brain-q brain-q-anythingllm" onclick="clickQuadrant('anythingllm')" onmouseenter="brainQHover(this,'anythingllm')" onmouseleave="brainQUnhover(this,'anythingllm')">
                        <div class="brain-q-tooltip">open</div>
                        <img id="bqAnythingImg" onerror="handleImgError(this)"/>
                        <div class="brain-q-label">ANYTHINGLLM</div>
                        <div class="brain-q-sublabel" id="bqAnythingSub"></div>
                    </div>
                </div>
                <div class="bot-descriptor" id="botDescriptor"></div>
            </div>
            <!-- RIGHT: ClawdBot -->
            <div class="brain-theirs">
                <div class="clawdbot-portrait">
                    <img src="http://127.0.0.1:8188/view?filename=clawdbot_logo.png&type=output" alt="ClawdBot" onerror="this.outerHTML='<svg viewBox=&quot;0 0 120 120&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;><circle cx=&quot;60&quot; cy=&quot;50&quot; r=&quot;35&quot; fill=&quot;none&quot; stroke=&quot;#e63946&quot; stroke-width=&quot;2&quot; opacity=&quot;0.6&quot;/><text x=&quot;60&quot; y=&quot;55&quot; text-anchor=&quot;middle&quot; fill=&quot;#e63946&quot; font-family=&quot;Space Mono,monospace&quot; font-size=&quot;10&quot;>CLAWDBOT</text></svg>'"/>
                </div>
                <div class="clawdbot-label">CLAWDBOT</div>
                <div class="vuln-panel" id="vulnPanel">
                    <div class="vuln-title" id="vulnTitle"></div>
                    <div class="vuln-body" id="vulnBody"></div>
                </div>
            </div>
        </div>

        <!-- Price badges -->
        <div class="brain-price-row">
            <div class="price-badge ours">$200 FLAT</div>
            <div class="price-badge theirs">$420-1,740/mo SCALES</div>
        </div>

        <!-- Ownership bar -->
        <div class="ownership-bar-wrap">
            <div class="ownership-bar" id="ownershipBar">
                <div class="own-local" id="ownLocal" style="width:80%">RUNS ON YOUR HARDWARE</div>
                <div class="own-cloud" id="ownCloud" style="width:20%">CLOUD API</div>
            </div>
            <div class="ownership-labels">
                <span>Infrastructure you own. Runs on electricity. Model-agnostic.</span>
                <span>Renting compute by the token.</span>
            </div>
        </div>
    </div>
</div>

<!-- SCHEMATIC FULL-SCREEN OVERLAY (over brain) -->
<div id="schematicOverlay">
    <div class="schematic-backdrop" onclick="closeFullSchematic()"></div>
    <div class="schematic-panel" onclick="event.stopPropagation()">
        <button class="schematic-close" onclick="closeFullSchematic()">&larr; BACK</button>
        <div id="schematicContent"></div>
    </div>
</div>

<!-- ARCHITECTURE COMPARISON — local-first vs cloud-only -->
<div class="compare-overlay" id="compareOverlay">
    <button class="compare-overlay-close" onclick="closeComparison()">&larr; BACK</button>
    <div class="compare-title">LOCAL-FIRST HYBRID vs CLOUD-ONLY</div>
    <div class="compare-subtitle">HOW THE AGILE LENS STACK COMPARES</div>
    <div class="compare-grid">
        <div class="compare-header good">AGILE LENS (HYBRID)</div>
        <div class="compare-header vs">VS</div>
        <div class="compare-header bad">CLOUD-ONLY</div>

        <div class="compare-row">
            <div class="compare-cell good">Cloud + local agents working together</div>
            <div class="compare-cell vs">AGENTS</div>
            <div class="compare-cell bad">Single provider dependency</div>
        </div>
        <div class="compare-row">
            <div class="compare-cell good">Ollama local inference ($0)</div>
            <div class="compare-cell vs">INFERENCE</div>
            <div class="compare-cell bad">All tokens are remote API calls</div>
        </div>
        <div class="compare-row">
            <div class="compare-cell good">RAG knowledge base grows daily</div>
            <div class="compare-cell vs">MEMORY</div>
            <div class="compare-cell bad">No persistent memory</div>
        </div>
        <div class="compare-row">
            <div class="compare-cell good">ComfyUI local renders ($0)</div>
            <div class="compare-cell vs">IMAGES</div>
            <div class="compare-cell bad">Remote API per image</div>
        </div>
        <div class="compare-row">
            <div class="compare-cell good">MCP tool orchestration</div>
            <div class="compare-cell vs">TOOLS</div>
            <div class="compare-cell bad">Basic function calling</div>
        </div>
        <div class="compare-row">
            <div class="compare-cell good">Knowledge transfers to local over time</div>
            <div class="compare-cell vs">TREND</div>
            <div class="compare-cell bad">Stays dependent on remote</div>
        </div>
    </div>
    <div class="compare-footer">CLICK ANYWHERE OR PRESS ESCAPE TO CLOSE</div>
</div>

<!-- NO prevBtn/nextBtn — DELETED -->
<script>
// ============================================================
// GITHUB PAGES PRODUCTION ASSET RESOLVER
// Generated by al_gh_deploy.py — DO NOT EDIT
// ============================================================
const GH_URL_MAP = {
    "Alex_action_fun_BE A DAD.webp": "https://xriel84.github.io/AgileAgents/assets/alex_action_fun_be-a-dad.webp",
    "Alex_action_fun_BECOME FIREFLIES.webp": "https://xriel84.github.io/AgileAgents/assets/alex_action_fun_become-fireflies.webp",
    "Alex_action_fun_CAST A SPELL.webp": "https://xriel84.github.io/AgileAgents/assets/alex_action_fun_cast-a-spell.webp",
    "Alex_action_fun_CHICKEN OUT.webp": "https://xriel84.github.io/AgileAgents/assets/alex_action_fun_chicken-out.webp",
    "Alex_action_fun_DO A FLIP.webp": "https://xriel84.github.io/AgileAgents/assets/alex_action_fun_do-a-flip.webp",
    "Alex_computer_still.png": "https://xriel84.github.io/AgileAgents/assets/alex_computer_still.png",
    "AnythingLLM_action_interact.webp": "https://xriel84.github.io/AgileAgents/assets/anythingllm_action_interact.webp",
    "AnythingLLM_action_upgrade_tier2.webp": "https://xriel84.github.io/AgileAgents/assets/anythingllm_action_upgrade_tier2.webp",
    "Claude Still.png": "https://xriel84.github.io/AgileAgents/assets/claude-still.png",
    "Goose interact.webp": "https://xriel84.github.io/AgileAgents/assets/goose-interact.webp",
    "Henry_action_fun_kick the tires.webp": "https://xriel84.github.io/AgileAgents/assets/henry_action_fun_kick-the-tires.webp",
    "Henry_action_work_review.webp": "https://xriel84.github.io/AgileAgents/assets/henry_action_work_review.webp",
    "Kevin_action_fun_GET FUNKY.webp": "https://xriel84.github.io/AgileAgents/assets/kevin_action_fun_get-funky.webp",
    "Kevin_action_fun_TRY BREAKDANCE.webp": "https://xriel84.github.io/AgileAgents/assets/kevin_action_fun_try-breakdance.webp",
    "Kevin_action_review.webp": "https://xriel84.github.io/AgileAgents/assets/kevin_action_review.webp",
    "Wide_alex_office.png": "https://xriel84.github.io/AgileAgents/assets/wide_alex_office.png",
    "alex office.png": "https://xriel84.github.io/AgileAgents/assets/alex-office.png",
    "alex_action_work_REVIEW .webp": "https://xriel84.github.io/AgileAgents/assets/alex_action_work_review-.webp",
    "alex_computer_action_upgrade.webp": "https://xriel84.github.io/AgileAgents/assets/alex_computer_action_upgrade.webp",
    "alex_idle.webp": "https://xriel84.github.io/AgileAgents/assets/alex_idle.webp",
    "alex_still.png": "https://xriel84.github.io/AgileAgents/assets/alex_still.png",
    "anything_still.png": "https://xriel84.github.io/AgileAgents/assets/anything_still.png",
    "ari_action_fun_WAKE UP.webp": "https://xriel84.github.io/AgileAgents/assets/ari_action_fun_wake-up.webp",
    "ari_action_medium_fun_GOOD JOB.webp": "https://xriel84.github.io/AgileAgents/assets/ari_action_medium_fun_good-job.webp",
    "ari_action_work_REVIEW.webp": "https://xriel84.github.io/AgileAgents/assets/ari_action_work_review.webp",
    "ari_computer_action_upgrade.webp": "https://xriel84.github.io/AgileAgents/assets/ari_computer_action_upgrade.webp",
    "ari_computer_still.png": "https://xriel84.github.io/AgileAgents/assets/ari_computer_still.png",
    "ari_loop_medium_fun.webp": "https://xriel84.github.io/AgileAgents/assets/ari_loop_medium_fun.webp",
    "ari_office.png": "https://xriel84.github.io/AgileAgents/assets/ari_office.png",
    "ari_still.png": "https://xriel84.github.io/AgileAgents/assets/ari_still.png",
    "claude_interact.webp": "https://xriel84.github.io/AgileAgents/assets/claude_interact.webp",
    "closeup_AnaBot_Idle_loop.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_anabot_idle_loop.webp",
    "closeup_EdBot_Idle_loop.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_edbot_idle_loop.webp",
    "closeup_EdBot_dissasemble.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_edbot_dissasemble.webp",
    "closeup_SBot__still.png": "https://xriel84.github.io/AgileAgents/assets/closeup_sbot__still.png",
    "closeup_SBot_dissasemble.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_sbot_dissasemble.webp",
    "closeup_anabot_Dissasembe.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_anabot_dissasembe.webp",
    "closeup_anabot_still.png": "https://xriel84.github.io/AgileAgents/assets/closeup_anabot_still.png",
    "closeup_aribot_dissasemble.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_aribot_dissasemble.webp",
    "closeup_aribot_idle.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_aribot_idle.webp",
    "closeup_aribot_still.png": "https://xriel84.github.io/AgileAgents/assets/closeup_aribot_still.png",
    "closeup_edbot_still.png": "https://xriel84.github.io/AgileAgents/assets/closeup_edbot_still.png",
    "closeup_sbot_idle.webp": "https://xriel84.github.io/AgileAgents/assets/closeup_sbot_idle.webp",
    "goose still.png": "https://xriel84.github.io/AgileAgents/assets/goose-still.png",
    "henry_action_fun_CRUNCH THE NUMBERS.webp": "https://xriel84.github.io/AgileAgents/assets/henry_action_fun_crunch-the-numbers.webp",
    "henry_computer_action_selectgpu.webp": "https://xriel84.github.io/AgileAgents/assets/henry_computer_action_selectgpu.webp",
    "henry_computer_still.png": "https://xriel84.github.io/AgileAgents/assets/henry_computer_still.png",
    "henry_idle_loop_medium.webp": "https://xriel84.github.io/AgileAgents/assets/henry_idle_loop_medium.webp",
    "henry_office.png": "https://xriel84.github.io/AgileAgents/assets/henry_office.png",
    "kevin_computer_gpu.webp": "https://xriel84.github.io/AgileAgents/assets/kevin_computer_gpu.webp",
    "kevin_computer_still.png": "https://xriel84.github.io/AgileAgents/assets/kevin_computer_still.png",
    "kevin_idle_loop.webp": "https://xriel84.github.io/AgileAgents/assets/kevin_idle_loop.webp",
    "kevin_office.png": "https://xriel84.github.io/AgileAgents/assets/kevin_office.png",
    "kevin_office_wide.png": "https://xriel84.github.io/AgileAgents/assets/kevin_office_wide.png",
    "llama_still.png": "https://xriel84.github.io/AgileAgents/assets/llama_still.png",
    "medium_anabot_idle.webp": "https://xriel84.github.io/AgileAgents/assets/medium_anabot_idle.webp",
    "medium_anabot_open.webp": "https://xriel84.github.io/AgileAgents/assets/medium_anabot_open.webp",
    "medium_anabot_still.png": "https://xriel84.github.io/AgileAgents/assets/medium_anabot_still.png",
    "medium_aribot__still.png": "https://xriel84.github.io/AgileAgents/assets/medium_aribot__still.png",
    "medium_aribot_buildagent.webp": "https://xriel84.github.io/AgileAgents/assets/medium_aribot_buildagent.webp",
    "medium_aribot_idle.webp": "https://xriel84.github.io/AgileAgents/assets/medium_aribot_idle.webp",
    "medium_sbot_idle.webp": "https://xriel84.github.io/AgileAgents/assets/medium_sbot_idle.webp",
    "medium_sbot_open.webp": "https://xriel84.github.io/AgileAgents/assets/medium_sbot_open.webp",
    "medium_sbot_still.png": "https://xriel84.github.io/AgileAgents/assets/medium_sbot_still.png",
    "ollama_action_upgrade.webp": "https://xriel84.github.io/AgileAgents/assets/ollama_action_upgrade.webp",
    "ollama_interact.webp": "https://xriel84.github.io/AgileAgents/assets/ollama_interact.webp",
    "proscenium_border_empty.png": "https://xriel84.github.io/AgileAgents/assets/proscenium_border_empty.png",
    "sklyine_back_layer.png": "https://xriel84.github.io/AgileAgents/assets/sklyine_back_layer.png",
    "skyline close left.png": "https://xriel84.github.io/AgileAgents/assets/skyline-close-left.png",
    "skyline close right.png": "https://xriel84.github.io/AgileAgents/assets/skyline-close-right.png",
    "skyline_middle layer center right.png": "https://xriel84.github.io/AgileAgents/assets/skyline_middle-layer-center-right.png",
    "skyline_middle layer far left.png": "https://xriel84.github.io/AgileAgents/assets/skyline_middle-layer-far-left.png",
    "skyline_middle layer far right.png": "https://xriel84.github.io/AgileAgents/assets/skyline_middle-layer-far-right.png",
    "skyline_middle_layer_center_left .png": "https://xriel84.github.io/AgileAgents/assets/skyline_middle_layer_center_left-.png",
    "wide_ari_office.png": "https://xriel84.github.io/AgileAgents/assets/wide_ari_office.png",
    "wide_aribot_cubicle_action.webp": "https://xriel84.github.io/AgileAgents/assets/wide_aribot_cubicle_action.webp",
    "wide_aribot_cubicle_still.png": "https://xriel84.github.io/AgileAgents/assets/wide_aribot_cubicle_still.png",
    "wide_edbot_cubicle_action.webp": "https://xriel84.github.io/AgileAgents/assets/wide_edbot_cubicle_action.webp",
    "wide_edbot_cubicle_still.png": "https://xriel84.github.io/AgileAgents/assets/wide_edbot_cubicle_still.png",
    "wide_henry_office .png": "https://xriel84.github.io/AgileAgents/assets/wide_henry_office-.png",
    "wide_sbot_cubicle_action.webp": "https://xriel84.github.io/AgileAgents/assets/wide_sbot_cubicle_action.webp",
    "wide_sbot_cubicle_still.png": "https://xriel84.github.io/AgileAgents/assets/wide_sbot_cubicle_still.png",
    "wide_tube receiver action open.webp": "https://xriel84.github.io/AgileAgents/assets/wide_tube-receiver-action-open.webp",
    "wide_tube_data_still.png": "https://xriel84.github.io/AgileAgents/assets/wide_tube_data_still.png",
    "wide_tube_receiver_still.png": "https://xriel84.github.io/AgileAgents/assets/wide_tube_receiver_still.png"
};

function assetUrl(filename) {
    if (!filename) return '';
    if (GH_URL_MAP[filename]) return GH_URL_MAP[filename];
    console.warn('Asset not in GH_URL_MAP:', filename);
    return `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256"><rect width="256" height="256" fill="#1a1a1a" rx="8"/><text x="128" y="120" text-anchor="middle" fill="#c9a84c" font-family="sans-serif" font-size="12">${filename.substring(0,30)}</text><text x="128" y="145" text-anchor="middle" fill="#555" font-family="sans-serif" font-size="10">not deployed</text></svg>`)}`;
}

function handleImgError(img) {
    const name = img.src.split('/').pop() || 'asset';
    console.log('Asset unavailable: ' + name);
    img.src = `data:image/svg+xml,${encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256"><rect width="256" height="256" fill="#1a1a1a" rx="8"/><text x="128" y="120" text-anchor="middle" fill="#c9a84c" font-family="sans-serif" font-size="12">${name.substring(0,30)}</text><text x="128" y="145" text-anchor="middle" fill="#555" font-family="sans-serif" font-size="10">asset unavailable</text></svg>`)}`;
    img.onerror = null;
}

// ============================================================
// ASSET MANIFEST — All filenames in one place
// Animated WebP loops natively in the browser. For state changes
// (idle→working→reaction) we just swap img.src.
// ============================================================
const ASSETS = {
    // ============================================================
    // ACTUAL FILENAMES from C:\ComfyUI_windows_portable\ComfyUI\output
    // Mapped from /internal/files/output scan on 2026-02-15
    // ============================================================

    // Office wide shots (isometric floor plan view)
    officeWide: {
        alex:  'Wide_alex_office.png',
        kevin: 'kevin_office_wide.png',
        henry: 'wide_henry_office .png',
        ari:   'wide_ari_office.png'
    },
    // Office zoom backdrops (front-facing, for zoom view)
    officeBg: {
        alex:  'alex office.png',
        kevin: 'kevin_office.png',
        henry: 'henry_office.png',
        ari:   'ari_office.png'
    },
    // Cubicle interiors (isometric floor plan view)
    cubicles: {
        aribot:  'wide_aribot_cubicle_still.png',
        sbot:    'wide_sbot_cubicle_still.png',
        edbot:   'wide_edbot_cubicle_still.png'
    },
    // Cubicle action animations (play once during pipeline step)
    cubicleLoops: {
        aribot:  'wide_aribot_cubicle_action.webp',
        sbot:    'wide_sbot_cubicle_action.webp',
        edbot:   'wide_edbot_cubicle_action.webp'
    },
    // Pneumatic tubes between cubicles
    tubes: {
        dataStill:     'wide_tube_data_still.png',
        dataLoop:      'wide_tube_data_loop.webp',
        receiverStill: 'wide_tube_receiver_still.png',
        receiverOpen:  'wide_tube receiver action open.webp'
    },
    // Proscenium frame
    prosceniumFrame: 'proscenium_border_empty.png',
    // Skyline depth layers — multiple pieces per depth
    // Back = furthest/dimmest, Mid = middle distance, Front = closest/foreground
    // front[0] ("close left") is the clickable hero building
    skyline: {
        back: ['sklyine_back_layer.png'],
        mid: [
            'skyline_middle layer far left.png',
            'skyline_middle_layer_center_left .png',
            'skyline_middle layer center right.png',
            'skyline_middle layer far right.png'
        ],
        front: [
            'skyline close left.png',
            'skyline close right.png'
        ]
    },
    // Character animated WebPs — per office
    // Convention: loop assets = *_loop_*, action assets = *_action_*
    // Falls back to still/idle if loop not ready (onerror on img)
    characters: {
        ari: {
            humanIdle:    'ari_still.png',
            humanReview:  'ari_action_work_REVIEW.webp',
            agentIdle:    'medium_aribot_idle.webp',
            agentLoop:    'medium_aribot_idle.webp',
            agentBuildagent: 'medium_aribot_buildagent.webp',
            agentWork:    null,
            agentOpen:    null,
            agentDance:   null,
            humanFunLoop: 'ari_loop_medium_fun.webp',
            funActions: {
                'WAKE UP':   'ari_action_fun_WAKE UP.webp',
                'GOOD JOB':  'ari_action_medium_fun_GOOD JOB.webp'
            }
        },
        kevin: {
            humanIdle:    'kevin_idle_loop.webp',
            humanReview:  'Kevin_action_review.webp',
            agentIdle:    'medium_anabot_idle.webp',
            agentLoop:    'medium_anabot_idle.webp',      // NEW: idle loop
            agentWork:    null,
            agentOpen:    'medium_anabot_open.webp',    // NEW: brain open action
            funActions: {
                'TRY BREAKDANCE':  'Kevin_action_fun_TRY BREAKDANCE.webp',
                'GET FUNKY':       'Kevin_action_fun_GET FUNKY.webp'
            }
        },
        henry: {
            humanIdle:    'henry_idle_loop_medium.webp',
            humanReview:  'Henry_action_work_review.webp',
            agentIdle:    'medium_sbot_idle.webp',     // FIXED: was wrong filename
            agentLoop:    'medium_sbot_idle.webp',     // NEW: idle loop
            agentWork:    null,
            agentOpen:    'medium_sbot_open.webp',   // NEW: brain open action
            funActions: {
                'KICK THE TIRES':      'Henry_action_fun_kick the tires.webp',
                'CRUNCH THE NUMBERS':  'henry_action_fun_CRUNCH THE NUMBERS.webp'
            }
        },
        alex: {
            humanStill:   'alex_still.png',
            humanIdle:    'alex_idle.webp',
            humanReview:  'alex_action_work_REVIEW .webp',
            agentIdle:    null,
            agentLoop:    null,
            agentWork:    null,
            agentOpen:    null,
            funActions: {
                'DO A FLIP':         'Alex_action_fun_DO A FLIP.webp',
                'BECOME FIREFLIES':  'Alex_action_fun_BECOME FIREFLIES.webp',
                'CHICKEN OUT':       'Alex_action_fun_CHICKEN OUT.webp',
                'BE A DAD':          'Alex_action_fun_BE A DAD.webp',
                'CAST A SPELL':      'Alex_action_fun_CAST A SPELL.webp'
            }
        }
    },
    // Brain components — stills (.png) for idle, animated (.webp) for reactions
    brain: {
        shellClosed: 'llama_still.png',
        shellOpen:   'ollama_interact.webp',
        ollamaUpgrade: 'ollama_action_upgrade.webp',
        ollama:      { idle: 'llama_still.png',       reaction: 'ollama_interact.webp', upgrade: 'ollama_action_upgrade.webp' },
        goose:       { idle: 'goose still.png',       reaction: 'Goose interact.webp' },
        claudeCode:  { idle: 'Claude Still.png',      reaction: 'claude_interact.webp' },
        memory:      { idle: 'anything_still.png',    reaction: 'AnythingLLM_action_interact.webp', upgrade: 'AnythingLLM_action_upgrade_tier2.webp' }
    },
    // Props
    desk:     null, // MISSING: artdeco_desk_00001_.png not on disk
    computer: null, // MISSING: artdeco_computer_00001_.png not on disk
    // Tower PC stills per character
    computerStill: {
        kevin: 'kevin_computer_still.png',
        ari:   'ari_computer_still.png',
        henry: 'henry_computer_still.png',
        alex:  'Alex_computer_still.png'
    },
    // Computer upgrade action animations
    computerUpgrade: {
        alex:  'alex_computer_action_upgrade.webp',
        henry: 'henry_computer_action_selectgpu.webp',
        kevin: 'kevin_computer_gpu.webp',
        ari:   'ari_computer_action_upgrade.webp'
    },
    // Agent cubicle stills (wide shot inner squares)
    cubicleStill: {
        aribot:    'wide_aribot_cubicle_still.png',
        sbot:      'wide_sbot_cubicle_still.png',
        edbot:     'wide_edbot_cubicle_still.png'
    },
    // Medium shot compositions — prefer loop, fallback to still
    mediumShot: {
        ari:   'medium_aribot_idle.webp',   // UPDATED: use new loop
        kevin: 'medium_anabot_idle.webp',       // UPDATED: use new loop
        henry: 'medium_sbot_idle.webp',      // UPDATED: use new loop
        alex:  null
    },
    // Medium shot stills (fallback when loops fail to load)
    mediumShotStill: {
        ari:   'medium_aribot__still.png',
        kevin: 'medium_anabot_still.png',
        henry: 'medium_sbot_still.png',
        alex:  null
    },
    // Medium shot open/activate animations
    mediumOpen: {
        ari:   null, // MISSING: no medium aribot open exists
        kevin: 'medium_anabot_open.webp',
        henry: 'medium_sbot_open.webp',
        alex:  null
    },
    // Medium shot disassemble animations (for brain building sequence)
    mediumDisassemble: {
        ari:   'closeup_aribot_dissasemble.webp',
        kevin: 'closeup_anabot_Dissasembe.webp',
        henry: 'closeup_SBot_dissasemble.webp',
        alex:  null
    },
    // Closeup shots — stills, idle loops, disassemble animations
    closeupStill: {
        edbot:  'closeup_edbot_still.png',
        sbot:   'closeup_SBot__still.png',
        anabot: 'closeup_anabot_still.png',
        aribot: 'closeup_aribot_still.png'
    },
    closeupIdle: {
        edbot:  'closeup_EdBot_Idle_loop.webp',
        sbot:   'closeup_sbot_idle.webp',
        anabot: 'closeup_AnaBot_Idle_loop.webp',
        aribot: 'closeup_aribot_idle.webp'
    },
    closeupDisassemble: {
        edbot:  'closeup_EdBot_dissasemble.webp',
        sbot:   'closeup_SBot_dissasemble.webp',
        anabot: 'closeup_anabot_Dissasembe.webp',
        aribot: 'closeup_aribot_dissasemble.webp'
    }
};

// ============================================================
// BOT_SPECS — Full specification data per bot
// ============================================================
const BOT_SPECS = {
    edbot: {
        name: 'EDBOT', role: 'Editor Agent', color: '#2a9d8f',
        portrait: 'medium_Edbot_still.png',
        descriptor: 'EdBot handles the full editing pipeline — rough cuts, format conversion, color grading workflow. Claude Code provides senior review and quality gates. Local models handle repetitive tasks like caption generation and thumbnail cropping.',
        quadrants: {
            claude: { lead: 'Senior review + quality gates. Approves final cuts. Generates editing rationale for RAG.', hasFlywheel: false },
            goose: {
                mcpServers: [
                    { name: 'DaVinci Resolve', software: 'DaVinci Resolve Studio 19', transport: 'stdio', tools: ['timeline_edit', 'color_grade', 'export_render'], status: 'active' },
                    { name: 'ComfyUI', software: 'ComfyUI v0.12 + Custom Nodes', transport: 'http', tools: ['generate_thumbnail', 'lora_style', 'batch_render'], status: 'active' },
                    { name: 'FFmpeg', software: 'FFmpeg 7.x', transport: 'stdio', tools: ['transcode', 'trim', 'concat', 'format_convert'], status: 'active' }
                ],
                localTools: ['file_watcher', 'render_queue', 'asset_catalog']
            },
            anythingllm: { kbCategories: ['WORKFLOWS', 'PROJECTS', 'LORE'], memoryTypes: ['Database', 'KB', 'RAG'], guardrails: 'Style guide enforcement + brand consistency checks' },
            ollama: { defaultModel: 'qwen25coder14b', altModels: ['mistral-nemo', 'llama33-70b'] }
        }
    },
    sbot: {
        name: 'SBOT', role: 'Security Agent', color: '#f1b844',
        portrait: 'medium_sbot_idle.webp',
        descriptor: 'SBot continuously audits MCP server integrity, scans for CVEs, and monitors the attack surface. Every tool connection is verified. Every dependency is tracked. If something looks wrong, SBot kills the connection first and asks questions later.',
        quadrants: {
            claude: { lead: 'Threat analysis + CVE triage. Generates security advisories. Reviews MCP server configs.', hasFlywheel: false },
            goose: {
                mcpServers: [
                    { name: 'Snyk', software: 'Snyk CLI', transport: 'http', tools: ['vuln_scan', 'dependency_audit', 'license_check'], status: 'active' },
                    { name: 'SearXNG', software: 'SearXNG (local instance)', transport: 'http', tools: ['threat_intel_search', 'cve_lookup'], status: 'active' },
                    { name: 'Filesystem', software: 'Node.js fs + chokidar', transport: 'stdio', tools: ['config_audit', 'permission_check', 'hash_verify'], status: 'active' }
                ],
                localTools: ['port_scanner', 'cert_checker', 'mcp_integrity_monitor']
            },
            anythingllm: { kbCategories: ['INFRA', 'RULES', 'SESSIONS'], memoryTypes: ['Database', 'KB', 'RAG'], guardrails: 'Zero-trust verification + audit trail logging' },
            ollama: { defaultModel: 'mistral-nemo', altModels: ['qwen25coder14b', 'llama33-70b'] }
        }
    },
    anabot: {
        name: 'ANABOT', role: 'Analytics Agent', color: '#457b9d',
        portrait: 'medium_anabot_idle.webp',
        descriptor: 'AnaBot tracks content performance across all platforms — views, CTR, engagement, revenue attribution. Feeds performance data back into the SEO brief loop. Turns raw metrics into actionable recommendations that improve the next content cycle.',
        quadrants: {
            claude: { lead: 'Strategic analysis + trend identification. Generates performance reports. Recommends content pivots.', hasFlywheel: false },
            goose: {
                mcpServers: [
                    { name: 'YouTube API', software: 'YouTube Data API v3', transport: 'http', tools: ['analytics_fetch', 'channel_stats', 'video_metrics'], status: 'active' },
                    { name: 'SearXNG', software: 'SearXNG (local instance)', transport: 'http', tools: ['competitor_analysis', 'trend_search'], status: 'active' },
                    { name: 'Filesystem', software: 'Node.js fs + chokidar', transport: 'stdio', tools: ['csv_export', 'report_write', 'data_archive'], status: 'active' }
                ],
                localTools: ['metric_aggregator', 'trend_detector', 'report_builder']
            },
            anythingllm: { kbCategories: ['DATA', 'PROJECTS', 'SESSIONS'], memoryTypes: ['Database', 'KB', 'RAG'], guardrails: 'Data integrity validation + anomaly flagging' },
            ollama: { defaultModel: 'qwen25coder14b', altModels: ['mistral-nemo', 'llama33-70b'] }
        }
    },
    aribot: {
        name: 'ARIBOT', role: 'Agent Orchestrator', color: '#2a9d8f',
        portrait: 'medium_aribot_idle.webp',
        descriptor: 'AriBot is the architect — designs, builds, and deploys the other agents. Manages the knowledge transfer flywheel that shifts workload from cloud to local over 12 months. The only bot that directly configures the dual-brain architecture.',
        quadrants: {
            claude: { lead: 'Architecture design + agent deployment. Writes agent configs. Manages flywheel calibration.', hasFlywheel: true },
            goose: {
                mcpServers: [
                    { name: 'Claude Code', software: 'Claude Code CLI', transport: 'stdio', tools: ['code_review', 'refactor', 'test_gen', 'deploy'], status: 'active' },
                    { name: 'AnythingLLM', software: 'AnythingLLM Desktop', transport: 'http', tools: ['kb_manage', 'workspace_config', 'embed_upload'], status: 'active' },
                    { name: 'Ollama', software: 'Ollama v0.6+', transport: 'http', tools: ['model_pull', 'model_run', 'quantize'], status: 'active' },
                    { name: 'Filesystem', software: 'Node.js fs + chokidar', transport: 'stdio', tools: ['config_write', 'log_read', 'backup'], status: 'active' }
                ],
                localTools: ['agent_deployer', 'config_validator', 'flywheel_calibrator']
            },
            anythingllm: { kbCategories: ['INFRA', 'RULES', 'WORKFLOWS', 'RAG', 'DATA', 'PROJECTS', 'SESSIONS', 'LORE'], memoryTypes: ['Database', 'KB', 'RAG'], guardrails: 'Full knowledge base access + cross-domain reasoning' },
            ollama: { defaultModel: 'llama33-70b', altModels: ['qwen25coder14b', 'mistral-nemo'] }
        }
    }
};

const CLAWDBOT_VULNS = {
    aribot: {
        title: 'VENDOR LOCK-IN',
        body: `ClawdBot was built on the Steinberger/OpenAI stack. <strong>Single provider dependency</strong> — when OpenAI changes pricing, raises rate limits, or deprecates an endpoint, the entire system breaks.<br><br>No local fallback. No model portability. Every query pays rent. The architecture can't even function during an API outage.`,
        stat: 'RISK: 100% cloud dependency · $0 local capability · 0 fallback models'
    },
    edbot: {
        title: 'SHALLOW CAPABILITY',
        body: `ClawdBot's "editing" is <strong>6-slide carousels and caption overlays</strong>. No DaVinci Resolve integration. No color grading. No multi-format export. Can't tell the difference between a jump cut and a J-cut.<br><br><strong>12% of ClawHub marketplace skills were malware</strong>. No LoRA training. No ComfyUI. Every image costs API tokens.`,
        stat: 'CONTAMINATED: 12% of marketplace was malware · 0 Resolve tools · 0 LoRA models'
    },
    sbot: {
        title: 'ATTACK SURFACE',
        body: `<strong>CVE-2026-25253</strong> — the OpenClaw agent vulnerability that exposed 17,500–30,000 instances (mostly individual dev deployments). ClawdBot runs the same architecture pattern: cloud agent with broad tool access and no local integrity monitoring.<br><br><strong>341 malicious ClawHub marketplace skills</strong> discovered in the wild. ClawdBot has no MCP integrity audit, no hash verification, no kill switch.`,
        stat: 'EXPOSED: 17.5–30K instances · 341 malicious skills · 0 local audit capability'
    },
    anabot: {
        title: 'COST SCALING',
        body: `Every analytics query ClawdBot runs costs <strong>~$0.50 in API tokens</strong>. Run 30 queries/day across content performance, that's <strong>$450-900/month</strong> just for analytics.<br><br>Output is flat markdown. No semantic search. No persistent memory. Same question asked twice costs twice. No RAG, no knowledge accumulation, no learning curve.`,
        stat: 'COST: ~$0.50/query · $450-900/mo analytics · 0 persistent memory'
    }
};

const GPU_TIERS = [
    { vram: '8 GB', gpu: 'RTX 5060 (TBA)', models: 'Qwen3 8B · Phi-4 14B (Q3)', capability: 'Junior dev tasks', price: '~$350-400' },
    { vram: '12 GB', gpu: 'RTX 5070', models: 'DeepSeek R1 14B · Mistral Small 25 (Q3)', capability: 'Mid-level autonomy', price: '~$650-750' },
    { vram: '16 GB', gpu: 'RTX 5070 Ti', models: 'Qwen3 Coder 14B · Phi-4-reasoning-plus', capability: 'Advanced coding', price: '~$820-900' },
    { vram: '32 GB', gpu: 'RTX 5090', models: 'DeepSeek R1 32B · Qwen 2.5 Coder 32B', capability: 'Senior code review', price: '~$3,500-5,000' },
    { vram: '48 GB', gpu: 'RTX A6000', models: 'Llama 3.3 70B', capability: 'Lead / Full autonomy', price: '~$4,100-5,000' }
];

const LLM_STATS = {
    'qwen3-8b':         { name: 'Qwen3 8B',          coding: 3, writing: 3, toolUse: 2, speed: '45 tok/s', minVram: 8 },
    'mistral-nemo':     { name: 'Mistral-Nemo 12B',   coding: 3, writing: 4, toolUse: 3, speed: '32 tok/s', minVram: 12 },
    'qwen25coder14b':   { name: 'Qwen 2.5 Coder 14B', coding: 4, writing: 3, toolUse: 4, speed: '28 tok/s', minVram: 16 },
    'qwen25coder32b':   { name: 'Qwen 2.5 Coder 32B', coding: 5, writing: 4, toolUse: 4, speed: '18 tok/s', minVram: 24 },
    'llama33-70b':      { name: 'Llama 3.3 70B',      coding: 5, writing: 5, toolUse: 5, speed: '18 tok/s', minVram: 48 }
};

const KB_CATEGORIES = ['DATA', 'INFRA', 'LORE', 'PROJECTS', 'RAG', 'RULES', 'SESSIONS', 'WORKFLOWS'];

const MEMORY_ARCH = [
    { type: 'Database', desc: 'Structured project data, agent configs, pipeline state. SQLite-backed.', detail: 'Stores agent deployment records, pipeline run history, configuration snapshots. Queryable with SQL. Persists across sessions.' },
    { type: 'Knowledge Base', desc: '8 category documents. Canonical reference. Human-curated.', detail: 'DATA · INFRA · LORE · PROJECTS · RAG · RULES · SESSIONS · WORKFLOWS — each category maintained as markdown docs synced from NB10/kb.' },
    { type: 'RAG Documents', desc: 'Embeddings + vector search. Auto-ingested from agent outputs.', detail: 'Every Claude interaction, every agent output, every review decision becomes a RAG document. Vector-searched at query time. Knowledge accumulates automatically.' }
];

// ============================================================
// LOAD ROOM BACKGROUNDS INTO ISOMETRIC FLOOR
// ============================================================
function loadRoomBackgrounds() {
    // Corner offices — perpendicular panels standing upright inside each floor square
    const officeMap = { alex: 'roomBgAlex', kevin: 'roomBgKevin', henry: 'roomBgHenry', ari: 'roomBgAri' };
    for (const [who, elId] of Object.entries(officeMap)) {
        const bgEl = document.getElementById(elId);
        if (!bgEl) continue;
        bgEl.style.display = 'none';
        const room = bgEl.closest('.room');
        if (room && ASSETS.officeWide[who]) {
            const panel = document.createElement('div');
            panel.className = 'room-panel';
            panel.innerHTML = `<img src="${assetUrl(ASSETS.officeWide[who])}" alt="${who} office" onerror="this.parentElement.style.display='none'"/>`;
            room.appendChild(panel);
        }
    }

    // Cubicles — perpendicular panels standing upright inside each cubicle square
    const cubMap = { 1: 'aribot', 2: 'sbot', 3: 'edbot' };
    for (const [num, key] of Object.entries(cubMap)) {
        const el = document.getElementById('roomBgCub' + num);
        if (!el) continue;
        el.style.display = 'none';
        const room = el.closest('.room');
        if (room && ASSETS.cubicles[key]) {
            const panel = document.createElement('div');
            panel.className = 'room-panel';
            panel.innerHTML = `<img src="${assetUrl(ASSETS.cubicles[key])}" alt="${key} cubicle" onerror="this.parentElement.style.display='none'"/>`;
            room.appendChild(panel);
        }
    }

    // Data tubes removed — cubicle action animations handle visual flow
}

// ============================================================
// LOAD SKYLINE PARALLAX LAYERS (multi-piece per depth)
// ============================================================
function loadSkyline() {
    const layers = { skyBack: 'back', skyMid: 'mid', skyFront: 'front' };
    for (const [elId, key] of Object.entries(layers)) {
        const el = document.getElementById(elId);
        const files = ASSETS.skyline[key];
        if (!el || !files) continue;
        const arr = Array.isArray(files) ? files : [files];
        el.innerHTML = arr.map(fn =>
            fn ? `<img src="${assetUrl(fn)}" alt="skyline ${key}" onerror="this.style.display='none'"/>` : ''
        ).join('');
    }
}

// ============================================================
// P2: FLYWHEEL BRAIN — Claude→Local Knowledge Transfer
// ============================================================
const flywheelNarratives = [
    { threshold: 0,  text: '<strong>Month 1:</strong> Claude does 80% of the work — $100/mo. Local models observe, learn, build RAG docs. Every task becomes a training example.' },
    { threshold: 26, text: '<strong>Month 3:</strong> Ollama handles routine tasks autonomously. Claude reviews edge cases only — $60/mo. RAG knowledge base growing daily.' },
    { threshold: 51, text: '<strong>Month 6:</strong> Local models handle 70% independently. Claude at $40/mo — senior review only. The flywheel is spinning.' },
    { threshold: 76, text: '<strong>Month 12:</strong> Local owns 90%+. Claude is $20/mo insurance, not operations. $625 training budget → $20 maintenance line.' }
];

// Flywheel node configs: { month1Size, month12Size, month1Cost }
const flywheelNodes = {
    claude:   { el: 'fwClaudeOrb',   costEl: 'fwClaudeCost', s1: 120, s12: 50,  c1: 100, c12: 20 },
    goose:    { el: 'fwGooseOrb',    costEl: null,           s1: 50,  s12: 90  },
    ollama:   { el: 'fwOllamaOrb',   costEl: null,           s1: 50,  s12: 100 },
    anything: { el: 'fwAnythingOrb', costEl: null,           s1: 40,  s12: 80  }
};

function updateFlywheel(val) {
    const t = val / 100; // 0..1

    // Interpolate node sizes
    for (const [key, cfg] of Object.entries(flywheelNodes)) {
        const orb = document.getElementById(cfg.el);
        if (!orb) continue;
        const size = Math.round(cfg.s1 + (cfg.s12 - cfg.s1) * t);
        orb.style.width = size + 'px';
        orb.style.height = size + 'px';
        // Update Claude usage label
        if (cfg.costEl) {
            const cost = Math.round(cfg.c1 + (cfg.c12 - cfg.c1) * t);
            document.getElementById(cfg.costEl).textContent = '$' + cost + '/mo';
        }
    }

    // Interpolate connection line thickness (thicker = more data to local)
    const localThickness = 1 + t * 3;
    const claudeThickness = 3 - t * 2;
    document.querySelectorAll('.flywheel-connections line').forEach((line, i) => {
        line.style.strokeWidth = (i < 2 ? claudeThickness : localThickness) + 'px';
        line.style.opacity = 0.2 + t * 0.4;
    });

    // Update narrative
    const narrative = document.getElementById('flywheelNarrative');
    if (narrative) {
        let text = flywheelNarratives[0].text;
        for (const n of flywheelNarratives) {
            if (val >= n.threshold) text = n.text;
        }
        narrative.innerHTML = text;
    }
}

// ============================================================
// FLYWHEEL NODE CLICK — swap still → interact animation
// ============================================================
function flywheelNodeClick(nodeKey) {
    const orbMap = {
        claude:   'fwClaudeOrb',
        goose:    'fwGooseOrb',
        ollama:   'fwOllamaOrb',
        anything: 'fwAnythingOrb'
    };
    const orb = document.getElementById(orbMap[nodeKey]);
    if (!orb) return;
    const img = orb.querySelector('img');
    const interactFile = orb.dataset.interact;
    const stillFile = orb.dataset.still;
    if (!img || !interactFile) return;

    img.src = assetUrl(interactFile);
    orb.style.boxShadow = '0 0 30px rgba(201,168,76,0.6)';
    setTimeout(() => {
        img.src = assetUrl(stillFile);
        orb.style.boxShadow = '';
    }, 3000);
}

// Initialize flywheel node images
function initFlywheelImages() {
    document.querySelectorAll('.flywheel-orb[data-still]').forEach(orb => {
        const img = orb.querySelector('img');
        if (img) img.src = assetUrl(orb.dataset.still);
    });
}

// ============================================================
// BRAIN SPLIT-SCREEN — open/close/render
// ============================================================
let currentBrainBot = null; // key into BOT_SPECS

function openBrain(agentIdOrBotKey) {
    // Accept direct bot key (e.g. 'edbot') or office id (e.g. 'ari')
    let botKey = BOT_SPECS[agentIdOrBotKey] ? agentIdOrBotKey : null;

    // Fallback: map office id to current sub-agent
    if (!botKey && agentIdOrBotKey === 'ari') {
        const data = zoomData.ari;
        if (data && data.subAgents && currentSubAgentIdx >= 0) {
            botKey = data.subAgents[currentSubAgentIdx].key;
        }
    }
    if (!botKey || !BOT_SPECS[botKey]) return;

    currentBrainBot = botKey;
    document.getElementById('brainOverlay').classList.add('active');

    if (typeof gsap !== 'undefined') {
        gsap.to('#spotWarm', { opacity: 0.8, duration: 0.6 });
        gsap.to('#spotCool', { opacity: 0, duration: 0.6 });
    }

    // Use selectBot flow to show portrait first
    selectBot(botKey);

    console.log(`%c\uD83E\uDDE0 BRAIN OPEN: ${BOT_SPECS[botKey].name} — split-screen comparison`, 'color: #c9a84c; font-weight: bold;');
}

function renderBrainView(botKey) {
    const spec = BOT_SPECS[botKey];
    if (!spec) return;

    // Title
    document.getElementById('brainTitle').textContent = `${spec.name}: AGENT ARCHITECTURE`;
    document.getElementById('brainSubtitle').textContent = 'CLICK A QUADRANT TO EXAMINE \u00B7 SWITCH TABS TO COMPARE';

    // Dossier tabs
    const tabsEl = document.getElementById('botDossierTabs');
    tabsEl.innerHTML = Object.entries(BOT_SPECS).map(([key, s]) =>
        `<div class="dossier-tab ${key === botKey ? 'active' : ''}" onclick="selectBot('${key}')" style="border-bottom-color: ${key === botKey ? s.color : 'transparent'}">
            ${s.name}<span class="tab-role">${s.role}</span>
        </div>`
    ).join('');

    // Left: descriptor
    document.getElementById('botDescriptor').textContent = spec.descriptor;

    // Left: quadrant images + sublabels
    const brain = ASSETS.brain;
    document.getElementById('bqClaudeImg').src = assetUrl(brain.claudeCode.idle);
    document.getElementById('bqGooseImg').src = assetUrl(brain.goose.idle);
    document.getElementById('bqOllamaImg').src = assetUrl(brain.ollama.idle);
    document.getElementById('bqAnythingImg').src = assetUrl(brain.memory.idle);

    document.getElementById('bqClaudeSub').textContent = spec.quadrants.claude.lead.substring(0, 50) + '...';
    document.getElementById('bqGooseSub').textContent = (spec.quadrants.goose.mcpServers.length) + ' MCP servers';
    document.getElementById('bqOllamaSub').textContent = 'Default: ' + (LLM_STATS[spec.quadrants.ollama.defaultModel]?.name || spec.quadrants.ollama.defaultModel);
    document.getElementById('bqAnythingSub').textContent = spec.quadrants.anythingllm.kbCategories.length + ' KB categories';

    // Right: vulnerability panel
    const vuln = CLAWDBOT_VULNS[botKey];
    if (vuln) {
        document.getElementById('vulnTitle').textContent = vuln.title;
        document.getElementById('vulnBody').innerHTML = vuln.body + '<div class="vuln-stat">' + vuln.stat + '</div>';
    }
}

function selectBot(botKey) {
    if (!BOT_SPECS[botKey]) return;
    currentBrainBot = botKey;

    const quadrants = document.getElementById('brainQuadrants');
    quadrants.style.display = 'none';

    let portrait = document.getElementById('brainBotPortrait');
    if (!portrait) {
        portrait = document.createElement('div');
        portrait.id = 'brainBotPortrait';
        portrait.style.cssText = 'text-align:center;cursor:pointer;position:relative;';
        quadrants.parentNode.insertBefore(portrait, quadrants);
    }

    const stillSrc = assetUrl(ASSETS.closeupStill?.[botKey] || ASSETS.closeupIdle?.[botKey] || ASSETS.mediumShotStill?.[botKey] || ASSETS.mediumShot?.[botKey]);
    const idleSrc = assetUrl(ASSETS.closeupIdle?.[botKey] || ASSETS.closeupStill?.[botKey] || ASSETS.mediumShot?.[botKey]);

    portrait.innerHTML = `
        <img id="brainPortraitImg" src="${stillSrc}" onerror="this.src='${idleSrc}'"
             style="max-height:400px;object-fit:contain;border-radius:6px;" />
        <div id="brainPortraitTooltip" style="display:none;position:absolute;
             background:rgba(10,10,10,0.95);border:1px solid var(--gold);
             color:var(--gold);font-family:'Poiret One',cursive;font-size:12px;
             letter-spacing:2px;padding:6px 14px;pointer-events:none;z-index:10;
             white-space:nowrap;">BOT BRAIN</div>`;
    portrait.style.display = 'block';

    const img = document.getElementById('brainPortraitImg');
    const tooltip = document.getElementById('brainPortraitTooltip');

    // Hover: idle loop + tooltip follows mouse
    portrait.onmouseenter = () => { img.src = idleSrc + '&t=' + Date.now(); tooltip.style.display = 'block'; };
    portrait.onmousemove = (e) => {
        const r = portrait.getBoundingClientRect();
        tooltip.style.left = (e.clientX - r.left + 12) + 'px';
        tooltip.style.top = (e.clientY - r.top - 30) + 'px';
    };
    portrait.onmouseleave = () => { img.src = stillSrc; tooltip.style.display = 'none'; };

    // Click: disassemble animation then fade to quadrant icons
    portrait.onclick = () => {
        const disSrc = ASSETS.closeupDisassemble?.[botKey]
            ? assetUrl(ASSETS.closeupDisassemble[botKey])
            : ASSETS.mediumDisassemble?.[botKey]
                ? assetUrl(ASSETS.mediumDisassemble[botKey])
                : null;
        tooltip.style.display = 'none';
        // Kill hover handlers so mouseleave can't interrupt the disassemble
        portrait.onmouseenter = null;
        portrait.onmouseleave = null;
        portrait.onmousemove = null;
        portrait.style.cursor = 'default';
        if (disSrc && typeof gsap !== 'undefined') {
            img.src = disSrc + '&t=' + Date.now();
            // Fade starts BEFORE animation ends — brain slides in over the final frames
            setTimeout(() => {
                gsap.to(portrait, { opacity: 0, duration: 0.4, onComplete: () => {
                    portrait.style.display = 'none'; portrait.style.opacity = '1';
                    quadrants.style.display = '';
                    renderBrainView(botKey);
                    animateBrainQuadrantsEntrance();
                }});
            }, 1800);
        } else {
            portrait.style.display = 'none';
            quadrants.style.display = '';
            renderBrainView(botKey);
            animateBrainQuadrantsEntrance();
        }
    };

    renderBrainView(botKey);
    if (typeof gsap !== 'undefined') {
        gsap.fromTo('.brain-split', { opacity: 0.3, y: 10 }, { opacity: 1, y: 0, duration: 0.35 });
    }
}

// §2A: Brain quadrant entrance animation — icons fly from center to final positions
// Fix: Use only percentage-based positions GSAP can tween (no 'auto'),
// and clearProps on complete so CSS classes resume control.
function animateBrainQuadrantsEntrance() {
    if (typeof gsap === 'undefined') return;
    const bq = document.getElementById('brainQuadrants');
    if (bq) bq.style.opacity = '1'; // ensure visible

    const quads = document.querySelectorAll('.brain-q');

    // All positions use top/left percentages with xPercent/yPercent for centering offset.
    // This avoids 'auto' which GSAP cannot interpolate.
    // Matches the CSS final positions:
    //   claude:      top:0   left:50%  translateX(-50%)
    //   goose:       top:50% left:0    translateY(-50%)
    //   ollama:      top:50% right:0   translateY(-50%)  → left: calc(100% - 196px) ≈ left:100%, xPercent:-100
    //   anythingllm: bottom:0 left:50% translateX(-50%)  → top: calc(100% - 196px) ≈ top:100%, yPercent:-100
    const finalPositions = {
        'brain-q-claude':      { top: '0%',   left: '50%',  xPercent: -50, yPercent: 0 },
        'brain-q-goose':       { top: '50%',  left: '0%',   xPercent: 0,   yPercent: -50 },
        'brain-q-ollama':      { top: '50%',  left: '100%', xPercent: -100, yPercent: -50 },
        'brain-q-anythingllm': { top: '100%', left: '50%',  xPercent: -50, yPercent: -100 }
    };

    quads.forEach(q => {
        // Clear any stale inline styles from previous animations first
        gsap.set(q, { clearProps: 'all' });
        // Then set starting position: centered, small, invisible
        gsap.set(q, {
            top: '50%', left: '50%',
            xPercent: -50, yPercent: -50,
            scale: 0.5, opacity: 0
        });
    });

    const lastIndex = quads.length - 1;
    quads.forEach((q, i) => {
        const cls = [...q.classList].find(c => c.startsWith('brain-q-') && c !== 'brain-q');
        const final = finalPositions[cls];
        if (!final) return;
        gsap.to(q, {
            ...final, scale: 1, opacity: 1,
            duration: 1, delay: i * 0.1,
            ease: 'back.out(1.4)',
            onComplete: i === lastIndex ? () => {
                // After all entrance tweens finish, wipe inline styles
                // so the CSS classes (.brain-q-claude etc.) resume control
                quads.forEach(el => gsap.set(el, { clearProps: 'all' }));
            } : undefined
        });
    });
}

const brainQImgMap = { claude: 'bqClaudeImg', goose: 'bqGooseImg', ollama: 'bqOllamaImg', anythingllm: 'bqAnythingImg' };
const brainQAssetMap = { claude: 'claudeCode', goose: 'goose', ollama: 'ollama', anythingllm: 'memory' };

// §3C: Hover → reaction animation plays; unhover → back to idle
function brainQHover(el, quadKey) {
    const img = document.getElementById(brainQImgMap[quadKey]);
    const brainAsset = ASSETS.brain[brainQAssetMap[quadKey]];
    if (img && brainAsset && brainAsset.reaction) {
        img.src = assetUrl(brainAsset.reaction);
    }
}
function brainQUnhover(el, quadKey) {
    const img = document.getElementById(brainQImgMap[quadKey]);
    const brainAsset = ASSETS.brain[brainQAssetMap[quadKey]];
    if (img && brainAsset && brainAsset.idle) {
        img.src = assetUrl(brainAsset.idle);
    }
}

// §1C/3D: Click → reaction animation → fade out → schematic opens
let _quadrantBusy = false; // double-click guard
function clickQuadrant(quadKey) {
    if (_quadrantBusy) return;
    _quadrantBusy = true;
    if (typeof gsap !== 'undefined') {
        gsap.to('#brainQuadrants', {
            opacity: 0, duration: 0.4, onComplete: () => {
                openFullSchematic(quadKey, currentBrainBot);
                _quadrantBusy = false;
            }
        });
    } else {
        openFullSchematic(quadKey, currentBrainBot);
        _quadrantBusy = false;
    }
}

function openFullSchematic(quadKey, botKey) {
    const spec = BOT_SPECS[botKey];
    if (!spec) return;

    const content = document.getElementById('schematicContent');
    content.innerHTML = '';

    if (quadKey === 'claude') buildClaudeSchematic(botKey, content);
    else if (quadKey === 'goose') buildGooseSchematic(botKey, content);
    else if (quadKey === 'anythingllm') buildAnythingSchematic(botKey, content);
    else if (quadKey === 'ollama') buildOllamaSchematic(botKey, content);

    document.getElementById('schematicOverlay').classList.add('active');
    console.log(`%c\uD83D\uDD27 SCHEMATIC: ${quadKey.toUpperCase()} for ${spec.name}`, 'color: #457b9d; font-weight: bold;');
}

function buildClaudeSchematic(botKey, container) {
    const spec = BOT_SPECS[botKey];
    const hasFlywheel = spec.quadrants.claude.hasFlywheel;
    const claudeIdleSrc = assetUrl(ASSETS.brain.claudeCode.idle);
    const claudeBurnSrc = assetUrl('claude_action_burning_tokens.webp');

    container.innerHTML = `
        <div class="schematic-title" style="color:var(--blue);">CLAUDE CODE — ${spec.name}</div>
        <div class="schematic-two-col">
            <div class="schematic-info-col">
                <p style="font-family:'Josefin Sans',sans-serif;font-size:12px;color:var(--cream);opacity:0.7;margin-bottom:16px;">
                    ${spec.quadrants.claude.lead}
                </p>
                <div class="claude-cost-printout">
                    <strong style="font-size:14px;">$200/mo FLAT</strong><br><br>
                    1\u00D7 Claude Premium &mdash; $100<br>
                    4\u00D7 Claude Standard &mdash; $25 ea<br>
                    <span style="opacity:0.5;">_________________________</span><br>
                    TOTAL: $200/mo<br>
                    PER POST: <strong>$0</strong><br><br>
                    <span style="opacity:0.6;font-size:9px;">High-volume caps (6.25× Pro for Premium).<br>Annual billing rate. Every agent shares seats.</span>
                </div>
                <div class="claude-burning-tokens" style="margin-top:12px;">
                    <strong style="font-size:14px;">$420-1,740+/mo SCALES</strong><br><br>
                    Per-token billing, no cap on cost<br>
                    ~$1.40-2.90 per agentic task (Opus)<br>
                    10-20 tasks/day = $420-1,740+/mo<br>
                    Extended thinking billed as output tokens<br><br>
                    <div class="burn-quote">
                        "ClawdBot burns API tokens asking Claude to write a for-loop. That's like hiring a lawyer to tie your shoes."
                    </div>
                </div>
            </div>
            <div class="schematic-icon-col">
                <img id="claudeBurnImg" class="schematic-header-img" src="${claudeIdleSrc}"
                     onmouseenter="this.src='${claudeBurnSrc}'+'&t='+Date.now()"
                     onmouseleave="this.src='${claudeIdleSrc}';this.style.display=''"
                     onerror="handleImgError(this)"
                     style="cursor:pointer;"/>
            </div>
        </div>
        ${hasFlywheel ? '<div id="flywheelMountPoint" style="margin-top:12px;"></div>' : ''}
    `;

    // If AriBot, move flywheel widget into schematic
    if (hasFlywheel) {
        const mount = document.getElementById('flywheelMountPoint');
        if (mount) {
            mount.innerHTML = `
                <div style="margin-top:16px;border:1px solid rgba(201,168,76,0.2);border-radius:4px;padding:14px;">
                    <div style="font-family:'Poiret One',cursive;font-size:14px;color:var(--gold);letter-spacing:2px;margin-bottom:10px;text-align:center;">KNOWLEDGE TRANSFER FLYWHEEL</div>
                    <div style="text-align:center;">
                        <input type="range" class="flywheel-slider" id="schematicFlywheelSlider" min="0" max="100" value="0" oninput="updateSchematicFlywheel(this.value)" style="width:100%;max-width:300px;">
                        <div class="flywheel-slider-labels" style="max-width:300px;margin:4px auto;">
                            <span>MONTH 1</span><span>MONTH 6</span><span>MONTH 12</span>
                        </div>
                    </div>
                    <div class="flywheel-narrative" id="schematicFlywheelNarrative" style="font-size:11px;min-height:40px;">
                        <strong>Month 1:</strong> Claude does 80% of the work. Local models watch and learn.
                    </div>
                </div>
            `;
        }
    }
}

// Flywheel in schematic context
function updateSchematicFlywheel(val) {
    const narrative = document.getElementById('schematicFlywheelNarrative');
    if (!narrative) return;
    let text = flywheelNarratives[0].text;
    for (const n of flywheelNarratives) {
        if (val >= n.threshold) text = n.text;
    }
    narrative.innerHTML = text;
}

function buildGooseSchematic(botKey, container) {
    const spec = BOT_SPECS[botKey];
    const goose = spec.quadrants.goose;
    const gooseIdleSrc = assetUrl(ASSETS.brain.goose.idle);
    const gooseHoverSrc = assetUrl(ASSETS.brain.goose.upgrade || ASSETS.brain.goose.reaction || ASSETS.brain.goose.idle);

    container.innerHTML = `
        <div class="schematic-title" style="color:var(--green);">GOOSE CLI — ${spec.name}</div>
        <div class="schematic-two-col">
            <div class="schematic-info-col">
                <p style="font-family:'Josefin Sans',sans-serif;font-size:12px;color:var(--cream);opacity:0.7;margin-bottom:16px;">
                    Model Context Protocol servers + local tools. Every tool runs on your hardware.
                </p>
                <div class="mcp-server-cards" style="grid-template-columns:1fr;">
                    ${goose.mcpServers.map(s => `
                        <div class="mcp-server-card">
                            <div class="mcp-info">
                                <div class="mcp-name">${s.name}</div>
                                <div class="mcp-software" style="font-size:9px;color:rgba(245,230,200,0.5);margin-top:2px;">${s.software || s.name}</div>
                                <div class="mcp-transport">${s.transport.toUpperCase()} · MCP SERVER</div>
                                <div class="mcp-tools">${s.tools.join(' \u00B7 ')}</div>
                                <div class="mcp-status ${s.status}">${s.status.toUpperCase()}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="local-tools-list">
                    <div class="lt-title">LOCAL TOOLS</div>
                    <div class="lt-items">
                        ${goose.localTools.map(t => `<span class="lt-item">${t}</span>`).join('')}
                    </div>
                </div>
            </div>
            <div class="schematic-icon-col">
                <img class="schematic-header-img" src="${gooseIdleSrc}"
                     onmouseenter="this.src='${gooseHoverSrc}'+'&t='+Date.now()"
                     onmouseleave="this.src='${gooseIdleSrc}';this.style.display=''"
                     onerror="handleImgError(this)"
                     style="cursor:pointer;"/>
            </div>
        </div>
    `;
}

function buildAnythingSchematic(botKey, container) {
    const spec = BOT_SPECS[botKey];
    const mem = spec.quadrants.anythingllm;
    // §8C: Different animation per card — reaction, upgrade (or hue-rotated reaction), hue-rotated variant
    const memAnimSrc = [
        assetUrl(ASSETS.brain.memory.reaction),
        assetUrl(ASSETS.brain.memory.upgrade || ASSETS.brain.memory.reaction),
        assetUrl(ASSETS.brain.memory.reaction)
    ];
    const memFilters = ['none', 'none', 'hue-rotate(120deg)'];
    const memIdleSrc = assetUrl(ASSETS.brain.memory.idle);
    const memHoverSrc = assetUrl('AnythingLLM_action_interact.webp');
    const memClickSrc = assetUrl('AnythingLLM_action_upgrade_tier3.webp');

    container.innerHTML = `
        <div class="schematic-title" style="color:#b080d0;">ANYTHINGLLM — ${spec.name}</div>
        <div class="schematic-two-col">
            <div class="schematic-info-col">
                <p style="font-family:'Josefin Sans',sans-serif;font-size:12px;color:var(--cream);opacity:0.7;margin-bottom:16px;">
                    ${mem.guardrails}
                </p>
                <div style="font-family:'Space Mono',monospace;font-size:10px;color:rgba(176,128,208,0.6);margin-bottom:12px;">
                    KB Categories: ${mem.kbCategories.join(' \u00B7 ')}
                </div>
                <div style="font-family:'Josefin Sans',sans-serif;font-size:11px;color:rgba(230,57,70,0.6);padding-top:10px;border-top:1px solid rgba(230,57,70,0.15);">
                    ClawdBot: Flat markdown. No semantic search. No persistent memory. Same question asked twice costs twice.
                </div>
                <div style="margin-top:auto;text-align:center;">
                    <img id="anythingBigIcon" class="schematic-header-img"
                         src="${memIdleSrc}" style="max-height:180px;cursor:pointer;"
                         onmouseenter="this.src='${memHoverSrc}'+'&t='+Date.now()"
                         onmouseleave="this.src='${memIdleSrc}';this.style.display=''"
                         onclick="this.src='${memClickSrc}'+'&t='+Date.now(); setTimeout(()=>document.getElementById('anythingBigIcon').src='${memIdleSrc}',3000)"
                         onerror="handleImgError(this)" />
                </div>
            </div>
            <div class="schematic-icon-col" style="flex-direction:column;gap:14px;">
                ${MEMORY_ARCH.map((m, i) => `
                    <div class="memory-type-card" onclick="memCardClick(this,${i})" style="width:100%;">
                        ${i === 2 ? `
                        <svg class="mem-expand-img" viewBox="0 0 64 80" style="width:48px;height:60px;opacity:0.7;">
                            <rect x="4" y="0" width="48" height="72" rx="3" fill="none" stroke="#b080d0" stroke-width="2"/>
                            <line x1="14" y1="18" x2="42" y2="18" stroke="#b080d0" stroke-width="1.5" opacity="0.5"/>
                            <line x1="14" y1="28" x2="42" y2="28" stroke="#b080d0" stroke-width="1.5" opacity="0.5"/>
                            <line x1="14" y1="38" x2="42" y2="38" stroke="#b080d0" stroke-width="1.5" opacity="0.5"/>
                            <line x1="14" y1="48" x2="32" y2="48" stroke="#b080d0" stroke-width="1.5" opacity="0.5"/>
                            <polygon points="36,0 52,16 36,16" fill="none" stroke="#b080d0" stroke-width="1.5" opacity="0.4"/>
                        </svg>` : `
                        <img class="mem-expand-img" id="memIcon${i}" src="${assetUrl(ASSETS.brain.memory.idle)}"
                             onerror="this.style.display='none'"
                             style="filter:${memFilters[i]};"/>`}
                        <div class="mem-title">${m.type}</div>
                        <div class="mem-summary">${m.desc}</div>
                        <div class="mem-detail">${m.detail}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// §8C: Memory card click — play unique animation per card + toggle expanded
const _memAnimSrcs = [
    () => assetUrl(ASSETS.brain.memory.reaction),
    () => assetUrl(ASSETS.brain.memory.upgrade || ASSETS.brain.memory.reaction),
    () => assetUrl(ASSETS.brain.memory.reaction)
];
const _memAnimFilters = ['none', 'none', 'hue-rotate(120deg)'];

function memCardClick(card, idx) {
    const img = card.querySelector('.mem-expand-img');
    if (img && idx < 2) {
        img.src = _memAnimSrcs[idx]() + '&t=' + Date.now();
        img.style.filter = _memAnimFilters[idx];
        setTimeout(() => {
            img.src = assetUrl(ASSETS.brain.memory.idle);
            img.style.filter = _memAnimFilters[idx];
        }, 3000);
    }
    card.classList.toggle('expanded');
}

function buildOllamaSchematic(botKey, container) {
    const spec = BOT_SPECS[botKey];
    const oll = spec.quadrants.ollama;
    const ollamaIdleSrc = assetUrl(ASSETS.brain.ollama.idle);
    const ollamaHoverSrc = assetUrl(ASSETS.brain.ollama.upgrade || ASSETS.brain.ollama.reaction || ASSETS.brain.ollama.idle);

    container.innerHTML = `
        <div class="schematic-title" style="color:var(--yellow);">OLLAMA — ${spec.name}</div>
        <div class="schematic-two-col">
            <div class="schematic-info-col">
                <p style="font-family:'Josefin Sans',sans-serif;font-size:12px;color:var(--cream);opacity:0.7;margin-bottom:16px;">
                    Local inference. $0/query. Swap models anytime.
                </p>
                <div style="font-family:'Poiret One',cursive;font-size:13px;color:var(--yellow);letter-spacing:2px;margin-bottom:10px;">MODEL PICKER</div>
                <div class="model-picker" id="modelPicker">
                    ${Object.entries(LLM_STATS).map(([key, m]) => `
                        <div class="model-option ${key === oll.defaultModel ? 'active-model' : ''}"
                             data-model-key="${key}"
                             onclick="selectOllamaModel(this,'${key}')"
                             onmouseenter="showLlmTooltip(event,'${key}')"
                             onmouseleave="hideLlmTooltip()">
                            <div class="model-name">${m.name}</div>
                            <div class="model-size">${m.speed}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="font-family:'Poiret One',cursive;font-size:13px;color:var(--gold);letter-spacing:2px;margin:16px 0 10px;">GPU TIER REFERENCE</div>
                <div class="gpu-tier-menu" id="gpuTierMenu">
                    ${[...GPU_TIERS].reverse().map((t, i) => `
                        <div class="gpu-tier-row ${t.vram === '48 GB' ? 'active-tier' : ''}"
                             onclick="selectGpuTier(this,${GPU_TIERS.length - 1 - i})">
                            <span class="tier-vram">${t.vram}</span>
                            <span class="tier-gpu">${t.gpu}</span>
                            <span class="tier-models">${t.models} — ${t.capability}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
            <div class="schematic-icon-col">
                <img class="schematic-header-img" src="${ollamaIdleSrc}"
                     onmouseenter="this.src='${ollamaHoverSrc}'+'&t='+Date.now()"
                     onmouseleave="this.src='${ollamaIdleSrc}';this.style.display=''"
                     onerror="handleImgError(this)"
                     style="max-height:225px;cursor:pointer;"/>
            </div>
        </div>
    `;
}

let _llmTooltipEl = null;
function showLlmTooltip(evt, modelKey) {
    const stats = LLM_STATS[modelKey];
    if (!stats) return;
    if (!_llmTooltipEl) {
        _llmTooltipEl = document.createElement('div');
        _llmTooltipEl.className = 'llm-stats-tooltip';
        document.body.appendChild(_llmTooltipEl);
    }
    const stars = n => '\u2605'.repeat(n) + '\u2606'.repeat(5 - n);
    _llmTooltipEl.innerHTML = `<strong style="color:var(--yellow)">${stats.name}</strong><br>
        Coding: ${stars(stats.coding)}<br>
        Writing: ${stars(stats.writing)}<br>
        Tool Use: ${stars(stats.toolUse)}<br>
        Speed: ${stats.speed}`;
    _llmTooltipEl.style.display = 'block';
    _llmTooltipEl.style.left = (evt.clientX + 12) + 'px';
    _llmTooltipEl.style.top = (evt.clientY - 10) + 'px';
}
function hideLlmTooltip() {
    if (_llmTooltipEl) _llmTooltipEl.style.display = 'none';
}

function selectOllamaModel(el, modelKey) {
    document.querySelectorAll('#modelPicker .model-option').forEach(o => o.classList.remove('active-model'));
    el.classList.add('active-model');
    // Play upgrade animation on the ollama quadrant
    const bqImg = document.getElementById('bqOllamaImg');
    if (bqImg && ASSETS.brain.ollama.upgrade) {
        bqImg.src = assetUrl(ASSETS.brain.ollama.upgrade);
        setTimeout(() => { bqImg.src = assetUrl(ASSETS.brain.ollama.idle); }, 2500);
    }
    if (typeof gsap !== 'undefined') {
        gsap.fromTo(el, { scale: 0.9 }, { scale: 1, duration: 0.3, ease: 'back.out(1.7)' });
    }
}

function selectGpuTier(el, tierIdx) {
    document.querySelectorAll('#gpuTierMenu .gpu-tier-row').forEach(r => r.classList.remove('active-tier'));
    el.classList.add('active-tier');
    if (typeof gsap !== 'undefined') {
        gsap.fromTo(el, { scale: 0.95 }, { scale: 1, duration: 0.25, ease: 'back.out(1.7)' });
    }

    // §5B: Filter model picker by GPU VRAM
    const selectedVram = parseInt(GPU_TIERS[tierIdx].vram);
    const modelOptions = document.querySelectorAll('#modelPicker .model-option');
    let bestRunnable = null;
    modelOptions.forEach(opt => {
        const modelKey = opt.dataset.modelKey;
        if (!modelKey || !LLM_STATS[modelKey]) return;
        const fits = LLM_STATS[modelKey].minVram <= selectedVram;
        if (fits) {
            opt.classList.remove('disabled-model');
            bestRunnable = opt;
        } else {
            opt.classList.add('disabled-model');
            opt.classList.remove('active-model');
        }
    });
    // Auto-select highest-ranked runnable model
    if (bestRunnable) {
        modelOptions.forEach(o => o.classList.remove('active-model'));
        bestRunnable.classList.add('active-model');
        // Play upgrade animation
        const bqImg = document.getElementById('bqOllamaImg');
        if (bqImg && ASSETS.brain.ollama.upgrade) {
            bqImg.src = assetUrl(ASSETS.brain.ollama.upgrade) + '&t=' + Date.now();
            setTimeout(() => { bqImg.src = assetUrl(ASSETS.brain.ollama.idle); }, 2500);
        }
        if (typeof gsap !== 'undefined') {
            gsap.fromTo(bestRunnable, { scale: 0.9 }, { scale: 1, duration: 0.3, ease: 'back.out(1.7)' });
        }
    }
}

function closeFullSchematic() {
    document.getElementById('schematicOverlay').classList.remove('active');
    _quadrantBusy = false; // reset double-click guard
    // §1C: Fade brain quadrants back in, then clear inline styles
    // so CSS classes control positioning on next open/close cycle
    if (typeof gsap !== 'undefined') {
        gsap.to('#brainQuadrants', {
            opacity: 1, duration: 0.4,
            onComplete: () => {
                document.querySelectorAll('.brain-q').forEach(q => {
                    gsap.set(q, { clearProps: 'all' });
                });
            }
        });
    } else {
        const bq = document.getElementById('brainQuadrants');
        if (bq) bq.style.opacity = '1';
        document.querySelectorAll('.brain-q').forEach(q => q.removeAttribute('style'));
    }
}

function closeBrain() {
    document.getElementById('brainOverlay').classList.remove('active');
    closeFullSchematic();
    // Reset portrait state
    const portrait = document.getElementById('brainBotPortrait');
    if (portrait) { portrait.style.display = 'none'; portrait.style.opacity = '1'; }
    const quadrants = document.getElementById('brainQuadrants');
    if (quadrants) quadrants.style.display = '';
    currentBrainBot = null;
    // Restore depth — handles direct close via X button or backdrop click
    // (drillUp already sets depth=2 before calling closeBrain, so this is a no-op in that path)
    if (depth === 3) depth = 2;
}

// ============================================================
// BUILDINGS + EXTERIOR SKYLINE
// ============================================================
(function(){
    const scene = document.getElementById('cityScene');
    // Load skyline PNGs into exterior layers
    // Size order: back (largest, full screen) > front > mid (smallest)
    function loadExtSkyline() {
        const layers = {
            extSkyBack:  { files: ASSETS.skyline.back,              style: 'width:100%;height:100%;object-fit:cover;' },          // fullscreen, ratio kept, edges crop
            extSkyMid:   { files: ASSETS.skyline.mid,               style: 'height:50vh;width:auto;object-fit:contain;flex-shrink:0;' },  // smallest
            extSkyFront: { files: [ASSETS.skyline.front[1]],        style: 'height:100%;width:auto;object-fit:contain;flex-shrink:0;' }   // full height, ratio kept
        };
        for (const [elId, cfg] of Object.entries(layers)) {
            const el = document.getElementById(elId);
            if (!el || !cfg.files) continue;
            const arr = Array.isArray(cfg.files) ? cfg.files : [cfg.files];
            el.innerHTML = arr.map(fn =>
                fn ? `<img src="${assetUrl(fn)}" alt="skyline" style="${cfg.style}" onerror="this.style.display='none'"/>` : ''
            ).join('');
        }
    }
    loadExtSkyline();

    // Load foreground building as clickable hero (close left = prominent)
    const heroImg = document.getElementById('heroBuildingImg');
    if (heroImg && ASSETS.skyline.front && ASSETS.skyline.front[0]) {
        heroImg.src = assetUrl(ASSETS.skyline.front[0]);
    }
    const st=document.getElementById('stars');
    for(let i=0;i<80;i++){
        const d=document.createElement('div');d.className='star';
        d.style.left=Math.random()*100+'%';d.style.top=Math.random()*45+'%';
        d.style.animationDelay=Math.random()*3+'s';
        d.style.width=d.style.height=(1+Math.random()*2)+'px';
        st.appendChild(d);
    }
})();

// ============================================================
// DEPTH NAVIGATION — replaces showView/currentView
// ============================================================
let depth = 0;        // 0=exterior, 1=interior, 2=zoom, 3=brain
let zoomTarget = null; // 'ari', 'kevin', 'henry', 'alex'
let isTransitioning = false;

// Bot status tracking — dormant → initializing → operational
const BOT_LEVELS = ['dormant', 'initializing', 'operational'];
const botStatus = {
    ari:   { level: 0, label: 'DORMANT' },
    kevin: { level: 0, label: 'DORMANT' },
    henry: { level: 0, label: 'DORMANT' }
};

function setBotStatus(who, level) {
    const bot = botStatus[who];
    if (!bot) return;
    bot.level = level;
    bot.label = ['DORMANT', 'INITIALIZING', 'OPERATIONAL'][level] || 'DORMANT';
    // Update DOM if status bar exists
    const bar = document.getElementById('statusBar_' + who);
    if (!bar) return;
    const segs = bar.querySelectorAll('.status-seg');
    const lbl = bar.querySelector('.status-label');
    segs.forEach((seg, i) => {
        seg.classList.toggle('filled', i < level + 1 && level > 0);
        seg.classList.toggle('green', level === 2 && i < level + 1);
    });
    if (lbl) {
        lbl.textContent = bot.label;
        lbl.classList.toggle('active', level === 2);
    }
    console.log(`%c🤖 ${who.toUpperCase()}BOT → ${bot.label}`, 'color: #2a9d8f; font-weight: bold;');
}

function renderStatusBar(who) {
    const bot = botStatus[who];
    if (!bot) return '';
    return `<div class="bot-status-bar" id="statusBar_${who}">
        <div class="status-segments">
            <div class="status-seg"></div>
            <div class="status-seg"></div>
            <div class="status-seg"></div>
        </div>
        <span class="status-label">${bot.label}</span>
    </div>`;
}

// Spotlight configs per depth layer
const spotlightConfigs = {
    0: { warm: 1, cool: 0, accent: 0 },
    1: { warm: 0, cool: 1, accent: 0 },
    2: { warm: 0, cool: 0, accent: 1 }
};

function updateSpotlights(viewIdx) {
    const cfg = spotlightConfigs[viewIdx] || {};
    if (typeof gsap !== 'undefined') {
        gsap.to('#spotWarm', { opacity: cfg.warm ?? 0, duration: 0.8 });
        gsap.to('#spotCool', { opacity: cfg.cool ?? 0, duration: 0.8 });
        gsap.to('#spotAccent', { opacity: cfg.accent ?? 0, duration: 0.8 });
    }
}

// Theatrical dim transition — lights out, silhouettes breathe, lights up
function theatricalTransition(fromEl, toEl, callback) {
    if (isTransitioning) return;
    isTransitioning = true;

    const blackout = document.getElementById('transBlackout');
    const silhouettes = document.getElementById('silhouetteRow');

    if (typeof gsap === 'undefined') {
        // Fallback: instant swap
        fromEl.classList.remove('active');
        toEl.classList.add('active');
        isTransitioning = false;
        if (callback) callback();
        return;
    }

    const tl = gsap.timeline({
        onComplete: () => { isTransitioning = false; if (callback) callback(); }
    });

    // Phase 1: Dim lights (0.4s)
    tl.to(blackout, { opacity: 1, duration: 0.4, ease: 'power2.in' })
    // Phase 2: Show silhouettes breathing in the dark (0.6s hold)
      .to(silhouettes, { opacity: 1, duration: 0.3 }, '-=0.1')
    // Phase 3: Swap views while dark
      .call(() => {
          fromEl.classList.remove('active');
          toEl.classList.add('active');
      })
    // Phase 4: Fade silhouettes
      .to(silhouettes, { opacity: 0, duration: 0.3 }, '+=0.3')
    // Phase 5: Bring lights up
      .to(blackout, { opacity: 0, duration: 0.5, ease: 'power2.out' }, '-=0.1');
}

// Exterior → Interior: special zoom-into-building transition
function zoomTransition(fromEl, toEl, callback) {
    if (isTransitioning) return;
    isTransitioning = true;

    if (typeof gsap === 'undefined') {
        fromEl.classList.remove('active');
        toEl.classList.add('active');
        isTransitioning = false;
        if (callback) callback();
        return;
    }

    const tl = gsap.timeline({
        onComplete: () => { isTransitioning = false; if (callback) callback(); }
    });

    tl.to(fromEl, { scale: 2.5, opacity: 0, duration: 0.8, ease: 'power3.in' })
      .call(() => {
          fromEl.classList.remove('active');
          gsap.set(fromEl, { scale: 1, opacity: 1 }); // reset for return
          toEl.classList.add('active');
      })
      .from(toEl, { opacity: 0, duration: 0.5, ease: 'power2.out' });
}

function drillDown(target) {
    if (isTransitioning) return;
    if (depth === 0) {
        depth = 1;
        preloadLayer(1);
        preloadLayer(2); // preload ahead
        zoomTransition(
            document.getElementById('exterior'),
            document.getElementById('interior')
        );
        updateSpotlights(1);
    } else if (depth === 1 && target) {
        depth = 2;
        zoomTarget = target;
        preloadLayer(2);
        preloadLayer(3); // preload ahead
        openZoom(target);
    } else if (depth === 2 && target === 'brain') {
        depth = 3;
        preloadLayer(3);
        openBrain(zoomTarget);
    }
}

function drillUp() {
    // If zoom overlay is visible, always close it regardless of depth state
    const zoomEl = document.getElementById('officeZoom');
    const brainEl = document.getElementById('brainOverlay');

    if (brainEl && brainEl.classList.contains('active')) {
        closeBrain();
        return;
    }

    if (zoomEl && zoomEl.classList.contains('active')) {
        depth = 1;
        closeZoom();
        return;
    }

    if (depth >= 1) {
        depth = 0;
        isTransitioning = false; // safety reset
        theatricalTransition(
            document.getElementById('interior'),
            document.getElementById('exterior')
        );
        updateSpotlights(0);
    }
}

// ============================================================
// NARRATIVE OVERLAY — brief fade, not persistent box
// ============================================================
function showNarrative(text) {
    let overlay = document.getElementById('narrativeOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'narrativeOverlay';
        overlay.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);backdrop-filter:blur(8px);padding:16px 32px;border:1px solid var(--gold);color:var(--cream);font-family:"Josefin Sans",sans-serif;font-size:14px;letter-spacing:1px;z-index:9999;opacity:0;transition:opacity 0.4s;pointer-events:none;max-width:80%;text-align:center;';
        document.body.appendChild(overlay);
    }
    overlay.innerHTML = text;
    overlay.style.opacity = '1';
    clearTimeout(overlay._fadeTimer);
    overlay._fadeTimer = setTimeout(() => overlay.style.opacity = '0', 3500);
}

// ============================================================
// FUN ACTION POOLS — Per-character toy button actions
// Entry format: [buttonLabel, animationText, spriteEffect, webpKey]
// ============================================================
const FUN_ACTIONS = {
    ari: [
        ['WAKE UP!', 'WAKE UP!', 'shake', 'WAKE UP']
    ],
    kevin: [
        ['TRY BREAKDANCE', 'BREAKDANCE!', 'bounce', 'TRY BREAKDANCE'],
        ['GET FUNKY', 'GET FUNKY!', 'shake', 'GET FUNKY']
    ],
    henry: [
        ['KICK THE TIRES', 'KICK THE TIRES!', 'bounce', 'KICK THE TIRES'],
        ['CRUNCH NUMBERS', 'CRUNCH THE NUMBERS!', 'shake', 'CRUNCH THE NUMBERS']
    ],
    alex: [
        ['DO A FLIP', 'DO A FLIP!', 'flip', 'DO A FLIP'],
        ['FIREFLIES', 'BECOME FIREFLIES!', 'glow', 'BECOME FIREFLIES'],
        ['CHICKEN OUT', 'CHICKEN OUT!', 'shake', 'CHICKEN OUT'],
        ['BE A DAD', 'BE A DAD!', 'nod', 'BE A DAD'],
        ['CAST A SPELL', 'CAST A SPELL!', 'glow', 'CAST A SPELL']
    ]
};

// Track which actions have been used to avoid immediate repeats
let funActionUsed = { ari: [], kevin: [], henry: [], alex: [] };

function getRandomAction(who) {
    const pool = FUN_ACTIONS[who];
    if (!pool) return null;
    const available = pool.filter((_, i) => !funActionUsed[who].includes(i));
    const usePool = available.length > 2 ? available : pool;
    if (available.length <= 2) funActionUsed[who] = [];
    const idx = Math.floor(Math.random() * usePool.length);
    const poolIdx = pool.indexOf(usePool[idx]);
    funActionUsed[who].push(poolIdx);
    return usePool[idx];
}

function applySpriteEffect(spriteId, effect) {
    const el = document.getElementById(spriteId);
    if (!el) return;
    const effects = {
        shake:  'transform: translateX(-5px); transition: 0.08s;',
        spin:   'transform: rotateY(180deg); transition: 0.6s;',
        bounce: 'transform: translateY(-20px); transition: 0.3s;',
        glow:   'filter: brightness(1.5) drop-shadow(0 0 15px var(--gold)); transition: 0.3s;',
        flip:   'transform: scaleX(-1); transition: 0.4s;',
        nod:    'transform: rotate(5deg); transition: 0.2s;'
    };
    const origStyle = el.getAttribute('style') || '';
    el.setAttribute('style', origStyle + ';' + (effects[effect] || ''));

    if (effect === 'shake') {
        let count = 0;
        const shakeInt = setInterval(() => {
            el.style.transform = count % 2 ? 'translateX(5px)' : 'translateX(-5px)';
            count++;
            if (count > 5) { clearInterval(shakeInt); el.style.transform = ''; }
        }, 80);
    } else {
        setTimeout(() => { el.setAttribute('style', origStyle); }, 1200);
    }
}

function pressFunButton(btn, who, spriteId) {
    // Use the action stored on this specific button (not random!)
    let action;
    try { action = JSON.parse(btn.dataset.action); } catch(e) { action = null; }
    if (!action) { action = getRandomAction(who); }
    if (!action) return;
    const [label, animText, effect, webpKey] = action;

    // Press animation on button
    btn.classList.add('pressed');

    // Show action text overlay
    const overlay = document.getElementById('funActionOverlay');
    if (overlay) {
        overlay.innerHTML = `<div class="fun-action-text">${animText}</div>`;
        overlay.classList.add('playing');
        setTimeout(() => overlay.classList.remove('playing'), 1600);
    }

    // Swap human sprite to fun action WebP if available
    const humanImg = document.getElementById(spriteId);
    const chars = ASSETS.characters[who];
    let swappedToWebp = false;
    if (humanImg && chars && chars.funActions && webpKey && chars.funActions[webpKey]) {
        humanImg.src = assetUrl(chars.funActions[webpKey]);
        humanImg.dataset.animating = '1';
        swappedToWebp = true;
        // Return to idle/still after animation plays (3s for looping webp)
        setTimeout(() => {
            delete humanImg.dataset.animating;
            humanImg.src = assetUrl((who === 'alex' && chars.humanStill) ? chars.humanStill : chars.humanIdle);
        }, 3000);
    }

    // Apply CSS sprite effect (always, as fallback or complement)
    if (!swappedToWebp) {
        applySpriteEffect(spriteId, effect);
    }

    // Respawn button with new action after delay
    setTimeout(() => {
        const newAction = getRandomAction(who);
        if (!newAction) return;
        btn.textContent = newAction[0];
        btn.dataset.action = JSON.stringify(newAction);
        btn.classList.remove('pressed');
        btn.classList.add('spawning');
        requestAnimationFrame(() => {
            requestAnimationFrame(() => btn.classList.add('ready'));
        });
        setTimeout(() => { btn.classList.remove('spawning', 'ready'); }, 500);
    }, 600);
}

// ============================================================
// ZOOM DATA — ALL 4 OFFICES
// ============================================================
const zoomData = {
    ari: {
        title: "ARI'S OFFICE",
        humanName: 'ARI', humanColor: '#2a9d8f',
        agentName: 'EDBOT', agentColor: '#2a9d8f',
        agentDesc: 'Editor Agent — Content Pipeline',
        agentDetail: 'Claude Code + Goose CLI hybrid. Manages editing workflow and content quality.',
        agentStack: 'Goose CLI + Claude Code + Ollama + LoRA + RAG',
        hasBrain: true,
        // 4 sub-agents: AriBot (slot 3), then EdBot/AnaBot/SBot (slot 4, replacing each other)
        subAgents: [
            { key: 'aribot', name: 'ARIBOT', color: '#2a9d8f', desc: 'Agent Orchestrator',
              idle: 'medium_aribot_idle.webp', loop: 'medium_aribot_idle.webp',
              buildagent: 'medium_aribot_buildagent.webp',
              slot: 'aribot' },
            { key: 'edbot',  name: 'EDBOT',  color: '#2a9d8f', desc: 'Editor Agent',
              idle: 'medium_Edbot_still.png', loop: 'medium_Edbot_still.png',
              open: 'medium_Edbot_open.webp',
              slot: 'farright' },
            { key: 'anabot', name: 'ANABOT', color: '#457b9d', desc: 'Analytics Agent',
              idle: 'medium_anabot_idle.webp', loop: 'medium_anabot_idle.webp',
              open: 'medium_anabot_open.webp',
              slot: 'farright' },
            { key: 'sbot',   name: 'SBOT',   color: '#f1b844', desc: 'Security Agent',
              idle: 'medium_sbot_idle.webp', loop: 'medium_sbot_idle.webp',
              open: 'medium_sbot_open.webp',
              slot: 'farright' }
        ],
        narrative: [
            'Building AriBot — agent orchestrator...',
            'AriBot online. Building EdBot — editor agent...',
            'EdBot online. Building AnaBot — analytics orchestrator...',
            'AnaBot online. Building SBot — security agent...',
            'All agents deployed.'
        ]
    },
    kevin: {
        title: "KEVIN'S OFFICE",
        humanName: 'KEVIN', humanColor: '#457b9d',
        narrative: [
            'Kevin oversees media production...',
            'Reviewing content pipeline output...'
        ]
    },
    henry: {
        title: "HENRY'S OFFICE",
        humanName: 'HENRY', humanColor: '#f1b844',
        narrative: [
            'Henry manages security and network...',
            'Running infrastructure audits...'
        ]
    },
    alex: {
        title: "ALEX'S OFFICE",
        humanName: 'ALEX', humanColor: '#e63946'
    }
};

const kevinSubagents = [
    { name: 'SBOT', role: 'Security', tier: 'T4', color: 'var(--red)',
      detail: 'MCP Integrity · CVE Scan · Compliance Audit' },
    { name: 'EDBOT', role: 'Editing', tier: 'T1', color: 'var(--green)',
      detail: 'FFmpeg · Whisper · Resolve · Smart Reframe' },
    { name: 'ANABOT', role: 'Analytics', tier: 'T3', color: 'var(--yellow)',
      detail: 'Metrics · CTR · Engagement · Feedback Loops' }
];

// ============================================================
// ZOOM MECHANICS — Simplified for v8
// ============================================================
let zoomState = { active: false, who: null, step: 0 };
let narrativeStage = 0;

function openZoom(who) {
    const data = zoomData[who];
    if (!data) return;
    zoomState = { active: true, who, step: 0 };
    narrativeStage = 0;

    const zoomEl = document.getElementById('officeZoom');
    const bgFile = ASSETS.officeBg[who];
    if (bgFile) zoomEl.style.backgroundImage = `url('${assetUrl(bgFile)}')`;
    zoomEl.style.backgroundSize = (who === 'kevin') ? 'contain' : 'cover';

    document.getElementById('zoomTitle').textContent = data.title;

    const chars = ASSETS.characters[who] || {};
    const scene = document.getElementById('deskScene');

    // ── ARI'S OFFICE: 4-slot layout ──
    if (who === 'ari') {
        const buildTooltip = ariBuildStep < data.subAgents.length
            ? `BUILD ${data.subAgents[ariBuildStep].name}` : '';

        const ariIdleSrc = chars.humanFunLoop || chars.humanIdle;
        const wakeLabel = ariWakeUpToggle === 0 ? 'WAKE UP' : 'GOOD JOB';

        scene.innerHTML = `
            <div class="fun-action-overlay" id="funActionOverlay"></div>
            <!-- SLOT 1: ARI (far left) -->
            <div class="figure-col ari-slot-human" id="ariSlot">
                <div class="col-label human">ARI</div>
                <div class="sprite-figure" data-tooltip="${wakeLabel}" id="ariClickable" onclick="ariWakeUpClick()">
                    <img class="sprite-anim" id="humanSprite"
                         src="${assetUrl(ariIdleSrc)}"
                         alt="ARI"
                         onerror="this.classList.add('placeholder')"/>
                </div>
            </div>
            <!-- SLOT 2: COMPUTER (middle left) -->
            <div class="desk-surface ari-slot-computer" id="computerArea">
                <div class="sprite-figure" style="width:auto;height:auto;"
                     data-tooltip="${buildTooltip}" id="computerClickable"
                     onclick="ariComputerClick()">
                    <img class="sprite-anim computer-hoverable" id="computerStillImg"
                         src="${assetUrl(ASSETS.computerStill.ari)}"
                         alt="Computer"
                         style="width:175px;height:auto;object-fit:contain;filter:drop-shadow(0 8px 20px rgba(0,0,0,0.6));cursor:pointer;"
                         onerror="this.style.display='none'"/>
                </div>
            </div>
            <!-- SLOT 3: ARIBOT (middle right, hidden until built) -->
            <div class="figure-col ari-slot-aribot agent-col" id="ariBotSlot">
                <div class="col-label agent" id="ariBotLabel" style="color:#2a9d8f">ARIBOT</div>
                <div class="sprite-figure agent-figure" style="--glow-color:#2a9d8f"
                     data-tooltip="BOT BRAIN" onclick="botSlotClick('aribot')">
                    <div class="scan-lines"></div>
                    <img class="sprite-anim" id="ariBotSprite"
                         src="${assetUrl('medium_aribot_idle.webp')}"
                         alt="ARIBOT"
                         onerror="this.classList.add('placeholder')"/>
                </div>
                <div class="holo-pedestal"></div>
            </div>
            <!-- SLOT 4: EDBOT/ANABOT/SBOT (far right, hidden until built) -->
            <div class="figure-col ari-slot-farright agent-col" id="farRightSlot">
                <div class="col-label agent" id="farRightLabel"></div>
                <div class="sprite-figure agent-figure" style="--glow-color:#2a9d8f"
                     data-tooltip="BOT BRAIN" onclick="farRightBotClick()">
                    <div class="scan-lines"></div>
                    <img class="sprite-anim" id="farRightSprite"
                         alt=""
                         onerror="this.classList.add('placeholder')"/>
                </div>
                <div class="holo-pedestal"></div>
            </div>
        `;

        // Restore state if returning to Ari's office
        restoreAriState();

        zoomEl.classList.add('active');
        return;
    }

    // ── OTHER OFFICES: standard 2-3 column layout ──
    const funA1 = getRandomAction(who);
    const funA2 = getRandomAction(who);
    const hasAgent = data.agentName;

    const humanSide = who === 'kevin' ? 'figure-center' : (hasAgent ? 'figure-left' : (who === 'henry' ? 'figure-left' : (who === 'alex' ? 'figure-center' : 'figure-center-right')));

    const funBtnsHtml = (!hasAgent && FUN_ACTIONS[who] && FUN_ACTIONS[who].length > 0) ? `<div class="fun-buttons" id="funButtons">
                <button class="fun-btn" onclick="pressFunButton(this,'${who}','humanSprite')"
                        data-action='${JSON.stringify(funA1)}'>${funA1 ? funA1[0] : ''}</button>
                <button class="fun-btn" onclick="pressFunButton(this,'${who}','humanSprite')"
                        data-action='${JSON.stringify(funA2)}'>${funA2 ? funA2[0] : ''}</button>
            </div>` : '';

    const spriteClick = `runNarrative('${who}')`;

    // Alex: default to still image, idle loop on hover
    const defaultSrc = (who === 'alex' && chars.humanStill) ? chars.humanStill : chars.humanIdle;
    const hoverHandlers = (who === 'alex' && chars.humanStill) ?
        `onmouseenter="this.src=assetUrl(ASSETS.characters.alex.humanIdle)"
         onmouseleave="if(!this.dataset.animating) this.src=assetUrl(ASSETS.characters.alex.humanStill)"` : '';

    scene.innerHTML = `
        <div class="fun-action-overlay" id="funActionOverlay"></div>
        <div class="figure-col ${humanSide}">
            ${funBtnsHtml}
            <div class="col-label human">${data.humanName}</div>
            <div class="sprite-figure" onclick="${spriteClick}">
                <img class="sprite-anim" id="humanSprite"
                     src="${assetUrl(defaultSrc)}"
                     alt="${data.humanName}"
                     ${hoverHandlers}
                     onerror="this.classList.add('placeholder')"/>
            </div>
        </div>
        <div class="desk-surface ${hasAgent ? '' : 'desk-right'}" id="computerArea"
             ${who === 'henry' ? 'style="bottom:60px;"' : ''}>
            <img class="sprite-anim" id="computerStillImg"
                 src="${assetUrl(ASSETS.computerStill[who])}"
                 alt="Computer"
                 data-still="${ASSETS.computerStill[who] || ''}"
                 data-upgrade="${ASSETS.computerUpgrade[who] || ''}"
                 style="width:${who === 'henry' ? '186' : '250'}px;height:auto;object-fit:contain;filter:drop-shadow(0 8px 20px rgba(0,0,0,0.6));cursor:pointer;"
                 onclick="clickComputer(this,'${who}')"
                 onerror="this.style.display='none'"/>
        </div>
        ${hasAgent ? `
        <div class="figure-col figure-right agent-col" id="agentSide">
            ${renderStatusBar('currentBot')}
            <div class="col-label agent" id="agentLabel">${data.agentName}</div>
            <div class="sprite-figure agent-figure" style="--glow-color:${data.agentColor}" onclick="agentClick('${who}')">
                <div class="scan-lines"></div>
                <img class="sprite-anim" id="agentSprite"
                     src="${assetUrl(chars.agentLoop || chars.agentIdle)}"
                     alt="${data.agentName}"
                     onerror="this.classList.add('placeholder')"/>
            </div>
            <div class="holo-pedestal"></div>
        </div>` : ''}
    `;

    zoomEl.classList.add('active');
}

function closeZoom() {
    document.getElementById('officeZoom').classList.remove('active');
    zoomState.active = false;
    // Safety resets — unblock any stuck state
    isTransitioning = false;
    computerAnimating = false;
    // Close brain too if somehow still open
    const brain = document.getElementById('brainOverlay');
    if (brain && brain.classList.contains('active')) {
        brain.classList.remove('active');
        currentBrainBot = null;
    }
}

// Human click — activates agent narrative
function humanClick(who) {
    const img = document.getElementById('humanSprite');
    if (!img) return;
    img.classList.add('reacting');
    setTimeout(() => img.classList.remove('reacting'), 600);
}

// ============================================================
// ARI: WAKE UP / GOOD JOB alternating click
// ============================================================
let ariWakeUpToggle = 0; // 0 = "WAKE UP", 1 = "GOOD JOB"

function ariWakeUpClick() {
    const img = document.getElementById('humanSprite');
    const chars = ASSETS.characters.ari;
    if (!img || !chars) return;

    const actionFile = ariWakeUpToggle === 0
        ? chars.funActions['WAKE UP']
        : chars.funActions['GOOD JOB'];
    if (!actionFile) return;

    img.src = assetUrl(actionFile);
    showNarrative(ariWakeUpToggle === 0 ? 'Wake up, Ari!' : 'Good job, Ari!');

    setTimeout(() => {
        // Return to fun loop idle
        img.src = assetUrl(chars.humanFunLoop || chars.humanIdle);
        // Toggle for next click
        ariWakeUpToggle = 1 - ariWakeUpToggle;
        // Update hover tooltip
        const clickable = document.getElementById('ariClickable');
        if (clickable) {
            clickable.setAttribute('data-tooltip', ariWakeUpToggle === 0 ? 'WAKE UP' : 'GOOD JOB');
        }
    }, 3000);
}

// ============================================================
// ARI: COMPUTER-DRIVEN BUILD SEQUENCE
// Build order: AriBot (slot 3) → EdBot → AnaBot → SBot (slot 4)
// ============================================================
let ariBuildStep = 0;       // 0=build aribot, 1=edbot, 2=anabot, 3=sbot, 4=all built
let farRightBotKey = null;  // tracks which bot is in slot 4

function ariComputerClick() {
    if (computerAnimating) return;
    const data = zoomData.ari;
    if (!data || !data.subAgents || ariBuildStep >= data.subAgents.length) {
        // All built — just play computer animation
        playComputerAnim();
        return;
    }

    const sub = data.subAgents[ariBuildStep];
    computerAnimating = true;

    // Play computer action animation
    const computerImg = document.getElementById('computerStillImg');
    if (!computerImg) { computerAnimating = false; return; }

    const upgradeFile = ASSETS.computerUpgrade.ari;
    const stillFile = ASSETS.computerStill.ari;
    computerImg.src = assetUrl(upgradeFile);
    computerImg.style.filter = 'drop-shadow(0 8px 25px rgba(201,168,76,0.5))';
    computerImg.style.marginTop = '-5%';

    showNarrative(`Building ${sub.name}...`);

    // Spawn bot immediately — appears alongside computer animation
    spawnAriBot(sub);
    ariBuildStep++;
    updateComputerTooltip();
    updatePipelineBtn();
    updateAriBotAnimation();

    setTimeout(() => {
        showNarrative(`${sub.name} online.`);
    }, 800);

    // Revert computer to still after animation completes
    setTimeout(() => {
        computerImg.src = assetUrl(stillFile);
        computerImg.style.filter = 'drop-shadow(0 8px 20px rgba(0,0,0,0.6))';
        computerImg.style.marginTop = '0';
        computerAnimating = false;
    }, 2500);
}

// Play computer action anim without building (when all bots built)
function playComputerAnim() {
    const computerImg = document.getElementById('computerStillImg');
    if (!computerImg) return;
    computerAnimating = true;
    const upgradeFile = ASSETS.computerUpgrade.ari;
    const stillFile = ASSETS.computerStill.ari;
    computerImg.src = assetUrl(upgradeFile);
    computerImg.style.filter = 'drop-shadow(0 8px 25px rgba(201,168,76,0.5))';
    computerImg.style.marginTop = '-5%';
    setTimeout(() => {
        computerImg.src = assetUrl(stillFile);
        computerImg.style.filter = 'drop-shadow(0 8px 20px rgba(0,0,0,0.6))';
        computerImg.style.marginTop = '0';
        computerAnimating = false;
    }, 2500);
}

function spawnAriBot(sub) {
    if (sub.slot === 'aribot') {
        // AriBot → slot 3 (middle right)
        const slot = document.getElementById('ariBotSlot');
        const sprite = document.getElementById('ariBotSprite');
        if (sprite) sprite.src = assetUrl(sub.idle);
        if (slot) {
            slot.classList.add('active');
            const fig = slot.querySelector('.sprite-figure');
            if (fig) {
                fig.classList.remove('holo-materialize');
                void fig.offsetWidth;
                fig.classList.add('holo-materialize');
            }
        }
    } else {
        // EdBot/AnaBot/SBot → slot 4 (far right), each replaces previous
        farRightBotKey = sub.key;
        const slot = document.getElementById('farRightSlot');
        const sprite = document.getElementById('farRightSprite');
        const label = document.getElementById('farRightLabel');

        if (sprite) sprite.src = assetUrl(sub.idle);
        if (label) {
            label.textContent = sub.name;
            label.style.color = sub.color;
        }

        const figure = slot ? slot.querySelector('.sprite-figure') : null;
        if (figure) {
            figure.style.setProperty('--glow-color', sub.color);
            figure.classList.remove('holo-materialize');
            void figure.offsetWidth;
            figure.classList.add('holo-materialize');
        }

        if (slot) slot.classList.add('active');
    }
}

function updateComputerTooltip() {
    const el = document.getElementById('computerClickable');
    if (!el) return;
    const data = zoomData.ari;
    if (ariBuildStep >= data.subAgents.length) {
        el.removeAttribute('data-tooltip');
    } else {
        el.setAttribute('data-tooltip', `BUILD ${data.subAgents[ariBuildStep].name}`);
    }
}

function updateAriBotAnimation() {
    const ariBotSprite = document.getElementById('ariBotSprite');
    if (!ariBotSprite) return;
    const chars = ASSETS.characters.ari;
    const data = zoomData.ari;
    // AriBot plays buildagent when bots are being built (step 2+ means EdBot built, more to go)
    if (ariBuildStep >= 2 && ariBuildStep < data.subAgents.length) {
        ariBotSprite.src = assetUrl(chars.agentBuildagent || chars.agentLoop);
    } else {
        ariBotSprite.src = assetUrl(chars.agentLoop || chars.agentIdle);
    }
}

// Restore Ari's office state when returning from brain or re-entering
function restoreAriState() {
    const data = zoomData.ari;
    if (!data || !data.subAgents) return;

    // Restore AriBot slot if built
    if (ariBuildStep >= 1) {
        const ariBotSlot = document.getElementById('ariBotSlot');
        if (ariBotSlot) ariBotSlot.classList.add('active');
    }

    // Restore far-right slot if applicable
    if (ariBuildStep >= 2 && farRightBotKey) {
        const sub = data.subAgents.find(s => s.key === farRightBotKey);
        if (sub) {
            const slot = document.getElementById('farRightSlot');
            const sprite = document.getElementById('farRightSprite');
            const label = document.getElementById('farRightLabel');
            if (sprite) sprite.src = assetUrl(sub.idle);
            if (label) { label.textContent = sub.name; label.style.color = sub.color; }
            const figure = slot ? slot.querySelector('.sprite-figure') : null;
            if (figure) figure.style.setProperty('--glow-color', sub.color);
            if (slot) slot.classList.add('active');
        }
    }

    // Update computer tooltip
    updateComputerTooltip();

    // Update AriBot animation state
    updateAriBotAnimation();
}

// ============================================================
// BOT SLOT CLICKS — open brain with specific bot tab
// ============================================================
function botSlotClick(botKey) {
    // AriBot click → open brain directly with aribot tab
    if (!botKey || !BOT_SPECS[botKey]) return;
    openBrainDirect(botKey);
}

function farRightBotClick() {
    if (!farRightBotKey || !BOT_SPECS[farRightBotKey]) return;
    const data = zoomData.ari;
    const sub = data ? data.subAgents.find(s => s.key === farRightBotKey) : null;

    // Play medium_open animation once, then open brain
    const sprite = document.getElementById('farRightSprite');
    if (sprite && sub && sub.open) {
        sprite.src = assetUrl(sub.open);
        setTimeout(() => {
            openBrainDirect(farRightBotKey);
            sprite.src = assetUrl(sub.idle || sub.loop);
        }, 1200);
    } else {
        openBrainDirect(farRightBotKey);
    }
}

function openBrainDirect(botKey) {
    if (!botKey || !BOT_SPECS[botKey]) return;
    currentBrainBot = botKey;
    depth = 3;
    document.getElementById('brainOverlay').classList.add('active');
    if (typeof gsap !== 'undefined') {
        gsap.to('#spotWarm', { opacity: 0.8, duration: 0.6 });
        gsap.to('#spotCool', { opacity: 0, duration: 0.6 });
    }
    // Use selectBot flow to show portrait first
    selectBot(botKey);
    console.log(`%c\uD83E\uDDE0 BRAIN OPEN: ${BOT_SPECS[botKey].name}`, 'color: #c9a84c; font-weight: bold;');
}

// Legacy compatibility — kept for non-Ari agents if needed
let currentSubAgentIdx = -1;

// Deploy pipeline from Ari's office — drill to floor, spawn cubicles, run sequence
function deployPipeline() {
    showNarrative('All agents operational. Deploying pipeline...');
    setTimeout(() => {
        drillUp(); // depth 2 → 1
        setTimeout(() => {
            spawnCubicleSequence();
        }, 800);
    }, 1500);
}

// Cubicle spawn sequence — light up departments one by one then run pipeline
function spawnCubicleSequence() {
    const depts = [
        { sel: '.cub-1', name: 'ARIBOT', color: 'var(--blue)', delay: 0 },
        { sel: '.cub-2', name: 'SBOT', color: 'var(--red)', delay: 1200 },
        { sel: '.cub-3', name: 'EDBOT', color: 'var(--green)', delay: 2400 }
    ];

    depts.forEach(d => {
        setTimeout(() => {
            const el = document.querySelector(d.sel);
            if (el) {
                el.classList.add('pipeline-active');
                el.style.setProperty('--glow-color', d.color);
                setTimeout(() => {
                    el.classList.remove('pipeline-active');
                    el.style.removeProperty('--glow-color');
                }, 1500);
            }
            showNarrative(`${d.name} deployed.`);
        }, d.delay);
    });

    const totalDelay = 2400 + 2000;
    setTimeout(() => {
        showNarrative('All departments online. Use RUN PIPELINE button.');
    }, totalDelay);
}

// Computer click — play upgrade animation (non-Ari offices), open GPU guide if selectgpu
let computerAnimating = false;
function clickComputer(img, who) {
    if (who === 'ari') return; // Ari uses ariComputerClick() instead
    if (computerAnimating || !img) return;
    const upgradeFile = ASSETS.computerUpgrade[who];
    const stillFile = ASSETS.computerStill[who];
    if (!upgradeFile) return;
    computerAnimating = true;
    img.src = assetUrl(upgradeFile);
    img.style.filter = 'drop-shadow(0 8px 25px rgba(201,168,76,0.5))';

    const isGpuSelect = upgradeFile.toLowerCase().includes('selectgpu');
    showNarrative(isGpuSelect
        ? 'Selecting GPU configuration...'
        : 'Upgrading ' + who.charAt(0).toUpperCase() + who.slice(1) + "'s workstation...");

    setTimeout(() => {
        img.src = assetUrl(stillFile);
        img.style.filter = 'drop-shadow(0 8px 20px rgba(0,0,0,0.6))';
        computerAnimating = false;
        if (isGpuSelect) openGpuGuide();
    }, 2500);
}

// GPU / Local LLM Shopping Guide overlay
function openGpuGuide() {
    let overlay = document.getElementById('gpuGuideOverlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'gpuGuideOverlay';
        overlay.innerHTML = `
            <button class="gpu-guide-close" onclick="closeGpuGuide()">&larr; BACK</button>
            <div class="gpu-guide-title">GPU &amp; LOCAL LLM SHOPPING GUIDE</div>
            <div class="gpu-guide-subtitle">CLICK ANYWHERE OR PRESS ESCAPE TO CLOSE</div>
            <table class="gpu-guide-table">
                <tr><th>VRAM</th><th>GPU</th><th>BEST LOCAL LLM (Q4)</th><th>CAPABILITY</th><th>PRICE</th></tr>
                <tr><td>8 GB</td><td>RTX 5060 (TBA)</td><td>Qwen3 8B · Phi-4 14B (Q3)</td><td>Junior dev tasks</td><td>~$350-400</td></tr>
                <tr><td>12-16 GB</td><td>RTX 5070 / 5070 Ti</td><td>Qwen3 Coder 14B · DeepSeek R1 14B</td><td>Mid-level autonomy</td><td>~$650-900</td></tr>
                <tr><td>32 GB</td><td>RTX 5090</td><td>DeepSeek R1 32B · Qwen 2.5 Coder 32B</td><td>Senior code review</td><td>~$3,500-5,000</td></tr>
                <tr class="gpu-highlight"><td>48 GB</td><td>RTX A6000</td><td>Llama 3.3 70B</td><td>Lead / Full autonomy</td><td>~$4,100-5,000</td></tr>
            </table>
            <div class="gpu-guide-footer">
                <div class="gpu-note">NB11 runs RTX A6000 (48GB) &mdash; Llama 3.3 70B at 18 tok/s local inference, $0/query</div>
                <div class="gpu-note">All models run via Ollama &rarr; AnythingLLM &rarr; RAG knowledge base</div>
            </div>
        `;
        document.body.appendChild(overlay);
        overlay.addEventListener('click', e => {
            if (!e.target.closest('.gpu-guide-table') && !e.target.closest('.gpu-guide-title')) closeGpuGuide();
        });
    }
    overlay.classList.add('active');
    console.log('%c🖥️ GPU GUIDE: Select your weapon', 'color: #2a9d8f; font-weight: bold;');
}

function closeGpuGuide() {
    const overlay = document.getElementById('gpuGuideOverlay');
    if (overlay) overlay.classList.remove('active');
}

// Protocol-triggered review animation (called by review mode system only)
function triggerReviewAnimation(who) {
    const chars = ASSETS.characters[who];
    const img = document.getElementById('humanSprite');
    if (!img || !chars || !chars.humanReview) return;
    img.src = assetUrl(chars.humanReview);
    img.dataset.animating = '1';
    setTimeout(() => {
        delete img.dataset.animating;
        img.src = assetUrl((who === 'alex' && chars.humanStill) ? chars.humanStill : chars.humanIdle);
    }, 3000);
}

// Agent click — legacy handler for non-Ari offices (Ari uses botSlotClick/farRightBotClick)
function agentClick(who) {
    if (who === 'ari') return; // Ari handled by dedicated slot click handlers
}

// ============================================================
// MEDIUM SHOT — "Building the Brain"
// ============================================================
function showMediumShot(who) {
    const msFile = ASSETS.mediumShot[who];
    const fallback = ASSETS.mediumShotStill ? ASSETS.mediumShotStill[who] : null;
    if (!msFile && !fallback) return;
    const container = document.getElementById('mediumShot');
    // Try loop first, fallback to still on error
    const fbAttr = fallback ? `onerror="this.src='${assetUrl(fallback)}'; this.onerror=null;"` : `onerror="this.parentElement.classList.remove('active')"`;
    container.innerHTML = `<img class="sprite-anim" src="${assetUrl(msFile || fallback)}" alt="Building the Brain" ${fbAttr}/>`;
    container.classList.add('active');
}

// ============================================================
// NARRATIVE — agent activation sequence
// ============================================================
function runNarrative(who) {
    const data = zoomData[who];
    if (!data) return;
    const chars = ASSETS.characters[who] || {};

    narrativeStage++;

    if (narrativeStage === 1) {
        // Agent is already visible — just narrate
        showNarrative(data.narrative ? data.narrative[0] : 'Activating...');
        let step = 0;
        function advanceAgent() {
            step++;
            if (step >= Math.min((data.narrative || []).length, 3)) {
                showNarrative((data.agentName || 'Agent') + ' online. Click to interact.');
                return;
            }
            if (data.narrative && data.narrative[step]) showNarrative(data.narrative[step]);
            setTimeout(advanceAgent, 1200);
        }
        setTimeout(advanceAgent, 1200);

    } else if (narrativeStage === 2 && who === 'kevin') {
        // Kevin: production narrative
        showNarrative('Kevin oversees media production. Press ESC → RUN PIPELINE on the floor.');
        const agentImg = document.getElementById('agentSprite');
        if (agentImg && chars.agentWork) agentImg.src = assetUrl(chars.agentWork);

        setTimeout(() => {
            if (agentImg && chars.agentIdle) agentImg.src = assetUrl(chars.agentLoop || chars.agentIdle);
        }, 2000);

    } else {
        // Flash reaction
        const img = document.getElementById('humanSprite');
        if (img) { img.classList.add('reacting'); setTimeout(() => img.classList.remove('reacting'), 600); }
    }
}

// ============================================================
// REVIEW MODE — Tier-based human review loops
// ============================================================
const REVIEW_CONFIG = {
    ari:   { tier: 'T1', label: 'FULL AUTOMATION CHECK', loop: 'ari_action_work_REVIEW.webp', color: 'var(--green)' },
    kevin: { tier: 'T2', label: 'CONTENT REVIEW', loop: 'Kevin_action_review.webp', color: 'var(--blue)' },
    henry: { tier: 'T3', label: 'BRAND & SECURITY', loop: 'Henry_action_work_review.webp', color: 'var(--yellow)' },
    alex:  { tier: 'T4', label: 'EXECUTIVE ANALYTICS', loop: 'alex_action_work_REVIEW .webp', color: 'var(--red)' }
};

function playReview(who) {
    const cfg = REVIEW_CONFIG[who];
    if (!cfg || !cfg.loop) return;
    const humanImg = document.getElementById('humanSprite');
    const chars = ASSETS.characters[who];
    if (!humanImg || !chars) return;
    humanImg.src = assetUrl(cfg.loop);
    humanImg.dataset.animating = '1';
    setTimeout(() => {
        delete humanImg.dataset.animating;
        humanImg.src = assetUrl((who === 'alex' && chars.humanStill) ? chars.humanStill : chars.humanIdle);
    }, 4000);
}

// ============================================================
// PIPELINE HELPERS — tubes, cubicle sprites, review overlays
// ============================================================

// Swap cubicle room-panel img between still and action animation
// Cache-bust the action URL so animated WebP restarts from frame 0 each time
function swapCubicleSprite(agentKey, toAction) {
    const room = document.querySelector(`.cubicle[data-agent="${agentKey}"]`);
    if (!room) return;
    const img = room.querySelector('.room-panel img');
    if (!img) return;
    if (toAction && ASSETS.cubicleLoops[agentKey]) {
        img.src = assetUrl(ASSETS.cubicleLoops[agentKey]) + '&t=' + Date.now();
    } else if (ASSETS.cubicles[agentKey]) {
        img.src = assetUrl(ASSETS.cubicles[agentKey]);
    }
}

// Data tube activation
function activateTube(tubeId) {
    const tube = document.getElementById(tubeId);
    if (!tube) return;
    tube.classList.add('active');
    if (ASSETS.tubes.dataLoop) tube.src = assetUrl(ASSETS.tubes.dataLoop);
}
function deactivateTube(tubeId) {
    const tube = document.getElementById(tubeId);
    if (!tube) return;
    tube.classList.remove('active');
    if (ASSETS.tubes.dataStill) tube.src = assetUrl(ASSETS.tubes.dataStill);
}
function activateAllTubes() {
    ['tube-kevin-edbot', 'tube-edbot-sbot', 'tube-sbot-ari'].forEach(activateTube);
}
function deactivateAllTubes() {
    ['tube-kevin-edbot', 'tube-edbot-sbot', 'tube-sbot-ari'].forEach(deactivateTube);
}

// Human review overlay — temporary sprites near Ari & Kevin offices
function showReviewOverlay() {
    const floor = document.querySelector('.iso-floor');
    if (!floor) return;
    const ariSprite = ASSETS.characters.ari.humanReview;
    const kevinSprite = ASSETS.characters.kevin.humanReview;

    if (ariSprite) {
        const ariImg = document.createElement('img');
        ariImg.className = 'review-overlay-sprite';
        ariImg.id = 'reviewOverlayAri';
        ariImg.src = assetUrl(ariSprite);
        ariImg.style.top = '520px';
        ariImg.style.left = '130px';
        ariImg.onerror = function() { this.style.display = 'none'; };
        floor.appendChild(ariImg);
        requestAnimationFrame(() => ariImg.classList.add('visible'));
    }

    if (kevinSprite) {
        setTimeout(() => {
            const kevImg = document.createElement('img');
            kevImg.className = 'review-overlay-sprite';
            kevImg.id = 'reviewOverlayKevin';
            kevImg.src = assetUrl(kevinSprite);
            kevImg.style.top = '65px';
            kevImg.style.left = '570px';
            kevImg.onerror = function() { this.style.display = 'none'; };
            floor.appendChild(kevImg);
            requestAnimationFrame(() => kevImg.classList.add('visible'));
        }, 800);
    }
}
function hideReviewOverlay() {
    const ari = document.getElementById('reviewOverlayAri');
    const kev = document.getElementById('reviewOverlayKevin');
    if (ari) { ari.classList.remove('visible'); setTimeout(() => ari.remove(), 600); }
    if (kev) { kev.classList.remove('visible'); setTimeout(() => kev.remove(), 600); }
}

// Executive review overlay — temporary sprites near Alex & Henry offices
function showExecReviewOverlay() {
    const floor = document.querySelector('.iso-floor');
    if (!floor) return;
    const alexSprite = ASSETS.characters.alex.humanReview;
    const henrySprite = ASSETS.characters.henry.humanReview;

    if (alexSprite) {
        const alexImg = document.createElement('img');
        alexImg.className = 'review-overlay-sprite';
        alexImg.id = 'reviewOverlayAlex';
        alexImg.src = assetUrl(alexSprite);
        alexImg.style.top = '65px';
        alexImg.style.left = '130px';
        alexImg.onerror = function() { this.style.display = 'none'; };
        floor.appendChild(alexImg);
        requestAnimationFrame(() => alexImg.classList.add('visible'));
    }

    if (henrySprite) {
        setTimeout(() => {
            const henImg = document.createElement('img');
            henImg.className = 'review-overlay-sprite';
            henImg.id = 'reviewOverlayHenry';
            henImg.src = assetUrl(henrySprite);
            henImg.style.top = '520px';
            henImg.style.left = '570px';
            henImg.onerror = function() { this.style.display = 'none'; };
            floor.appendChild(henImg);
            requestAnimationFrame(() => henImg.classList.add('visible'));
        }, 800);
    }
}
function hideExecReviewOverlay() {
    const alex = document.getElementById('reviewOverlayAlex');
    const hen = document.getElementById('reviewOverlayHenry');
    if (alex) { alex.classList.remove('visible'); setTimeout(() => alex.remove(), 600); }
    if (hen) { hen.classList.remove('visible'); setTimeout(() => hen.remove(), 600); }
}

// ============================================================
// PIPELINE ON FLOOR — offices + cubicles glow in sequence
// ============================================================
const PIPELINE_STEPS = [
    // STAGE 1 — TREND ANALYSIS: AnaBot in Kevin's office
    { target: 'office-kevin', text: 'ANABOT: Trend analysis complete · Content brief drafted · Keywords locked', color: 'var(--gold)', duration: 3000 },
    // STAGE 2 — ASSET GENERATION: EdBot cubicle
    { target: 'cubicle-edbot', text: 'EDBOT: Thumbnail + banner via ComfyUI + LoRA · B-roll via LTX-2 · $0', color: 'var(--green)', duration: 3000 },
    // STAGE 3 — COMPLIANCE: SBot cubicle
    { target: 'cubicle-sbot', text: 'SBOT: Compliance audit · MCP integrity check · Brand safety · PASS ✓', color: 'var(--red)', duration: 2500 },
    // STAGE 4 — HUMAN REVIEW: Ari + Kevin
    { target: 'review', text: 'HUMAN REVIEW: Ari approves creative · Kevin confirms publish gate', color: 'var(--blue)', duration: 3500 },
    // STAGE 5 — DISTRIBUTE: All rooms pulse
    { target: 'all', text: 'DISTRIBUTED: Content live · TikTok + IG + YT + LinkedIn · $0 per post', color: 'var(--gold)', duration: 2500 },
    // STAGE 6 — EXECUTIVE APPROVAL: Alex + Henry
    { target: 'exec-review', text: 'EXECUTIVE APPROVAL: Alex signs off on strategy · Henry validates security posture', color: 'var(--red)', duration: 3500 },
    // STAGE 7 — LOOP: Analytics back to Kevin
    { target: 'office-kevin', text: 'ANABOT: Views +23% WoW · CTR 4.2% · Performance data → next brief · CYCLE RESTARTS', color: 'var(--gold)', duration: 3000 }
];

let pipelineRunning = false;

function getTargetElements(target) {
    if (target === 'office-kevin') return [document.querySelector('[data-agent="kevin"]')];
    if (target === 'office-ari') return [document.querySelector('[data-agent="ari"]')];
    if (target === 'cubicle-sbot') return [document.querySelector('[data-agent="sbot"]')];
    if (target === 'cubicle-edbot') return [document.querySelector('[data-agent="edbot"]')];
    if (target === 'cubicle-aribot') return [document.querySelector('[data-agent="aribot"]')];
    if (target === 'review') return [document.querySelector('[data-agent="ari"]'), document.querySelector('[data-agent="kevin"]')];
    if (target === 'exec-review') return [document.querySelector('[data-agent="alex"]'), document.querySelector('[data-agent="henry"]')];
    if (target === 'all') return [...document.querySelectorAll('.room')];
    return [];
}

function ensurePipelineTicker() {
    let ticker = document.getElementById('pipelineTicker');
    if (!ticker) {
        ticker = document.createElement('div');
        ticker.id = 'pipelineTicker';
        ticker.className = 'pipeline-ticker';
        document.body.appendChild(ticker);
    }
    return ticker;
}

// ============================================================
// COMIC PANEL POPUPS — closeup sprites during pipeline steps
// ============================================================

// Map pipeline step index to comic panel config
// side alternates left/right; null = no panel for that step
const COMIC_PANELS = [
    // Step 0: ANABOT trend analysis (Kevin's office)
    { side: 'left', sprite: () => assetUrl(ASSETS.closeupIdle.anabot), name: 'ANABOT', color: '#457b9d',
      caption: 'Trend analysis active — scanning performance data' },
    // Step 1: EDBOT asset generation (cubicle)
    { side: 'right', sprite: () => assetUrl(ASSETS.closeupIdle.edbot), name: 'EDBOT', color: '#2a9d8f',
      caption: 'Generating thumbnails + banners via ComfyUI' },
    // Step 2: SBOT compliance (cubicle)
    { side: 'left', sprite: () => assetUrl(ASSETS.closeupIdle.sbot), name: 'SBOT', color: '#f1b844',
      caption: 'MCP integrity check — compliance audit running' },
    // Step 3: Human review — Ari left, Kevin right
    { side: 'both',
      left:  { sprite: () => assetUrl(ASSETS.characters.ari.humanReview), name: 'ARI', color: 'var(--blue)',
               caption: 'Creative approval — human in the loop' },
      right: { sprite: () => assetUrl(ASSETS.characters.kevin.humanReview), name: 'KEVIN', color: 'var(--gold)',
               caption: 'Publish gate — final sign-off' }
    },
    // Step 4: Distribute — no panel
    null,
    // Step 5: Executive approval — Alex left, Henry right
    { side: 'both',
      left:  { sprite: () => assetUrl(ASSETS.characters.alex.humanReview), name: 'ALEX', color: 'var(--red)',
               caption: 'Strategy sign-off — executive approval' },
      right: { sprite: () => assetUrl(ASSETS.characters.henry.humanReview), name: 'HENRY', color: 'var(--green)',
               caption: 'Security posture validated — all clear' }
    },
    // Step 6: ANABOT analytics loop
    { side: 'right', sprite: () => assetUrl(ASSETS.closeupIdle.anabot), name: 'ANABOT', color: '#457b9d',
      caption: 'Performance data feeding next content cycle' }
];

let activeComicPanels = [];

function spawnComicPanel(side, spriteUrl, name, color, caption) {
    const panel = document.createElement('div');
    panel.className = 'comic-panel panel-' + side;
    panel.style.color = color;
    panel.innerHTML =
        '<div class="comic-panel-frame">' +
            '<img src="' + spriteUrl + '" alt="' + name + '" onerror="this.style.display=\'none\'">' +
        '</div>' +
        '<div class="comic-panel-caption">' +
            '<div class="comic-panel-name">' + name + '</div>' +
            caption +
        '</div>';
    document.body.appendChild(panel);
    requestAnimationFrame(() => {
        requestAnimationFrame(() => panel.classList.add('visible'));
    });
    activeComicPanels.push(panel);
    return panel;
}

function clearComicPanels() {
    activeComicPanels.forEach(panel => {
        panel.classList.remove('visible');
        panel.classList.add('fade-out');
        setTimeout(() => panel.remove(), 450);
    });
    activeComicPanels = [];
}

function showComicForStep(stepIdx) {
    clearComicPanels();
    const cfg = COMIC_PANELS[stepIdx];
    if (!cfg) return;

    if (cfg.side === 'both') {
        if (cfg.left) spawnComicPanel('left', cfg.left.sprite(), cfg.left.name, cfg.left.color, cfg.left.caption);
        if (cfg.right) spawnComicPanel('right', cfg.right.sprite(), cfg.right.name, cfg.right.color, cfg.right.caption);
    } else {
        spawnComicPanel(cfg.side, cfg.sprite(), cfg.name, cfg.color, cfg.caption);
    }
}

// Smart pipeline button — routes to Ari's office before bots built, runs pipeline after
function handlePipelineBtn() {
    const data = zoomData.ari;
    const allBuilt = data && data.subAgents && ariBuildStep >= data.subAgents.length;
    if (allBuilt) {
        runPipelineSequence();
    } else {
        // Navigate to Ari's office
        openZoom('ari');
    }
}

function updatePipelineBtn() {
    const btn = document.querySelector('.pipeline-run-btn');
    if (!btn) return;
    const data = zoomData.ari;
    const allBuilt = data && data.subAgents && ariBuildStep >= data.subAgents.length;
    if (allBuilt) {
        btn.textContent = '\u25B6 RUN PIPELINE';
    } else {
        btn.textContent = '\u25B6 GO TO ARI\'S OFFICE';
    }
}

function runPipelineSequence() {
    if (pipelineRunning) return;
    pipelineRunning = true;

    const btn = document.querySelector('.pipeline-run-btn');
    if (btn) { btn.disabled = true; btn.textContent = 'PIPELINE RUNNING...'; }
    const ticker = ensurePipelineTicker();

    console.log('%c\uD83D\uDD25 PIPELINE RUNNING — hold onto your butts', 'color: #e63946; font-weight: bold;');

    let stepIdx = 0;

    function clearGlow() {
        // Reset room glow
        document.querySelectorAll('.room.pipeline-active').forEach(el => {
            el.classList.remove('pipeline-active');
            el.style.removeProperty('--glow-color');
        });
        // Reset cubicle sprites to stills
        ['edbot', 'sbot', 'aribot'].forEach(key => swapCubicleSprite(key, false));
        // Hide review overlays
        hideReviewOverlay();
        hideExecReviewOverlay();
        // Clear previous comic panels
        clearComicPanels();
    }

    function nextStep() {
        clearGlow();
        if (stepIdx >= PIPELINE_STEPS.length) {
            pipelineRunning = false;
            clearComicPanels();
            if (btn) { btn.disabled = false; updatePipelineBtn(); }
            ticker.classList.remove('active');
            showNarrative('Pipeline cycle complete. Click an office to explore.');
            console.log('%c\uD83C\uDFAC PIPELINE COMPLETE', 'color: #2a9d8f; font-weight: bold;');
            return;
        }
        const step = PIPELINE_STEPS[stepIdx];
        const targets = getTargetElements(step.target);

        // Glow active rooms
        targets.forEach(el => {
            if (!el) return;
            el.classList.add('pipeline-active');
            el.style.setProperty('--glow-color', step.color);
        });

        // Swap cubicle sprite to action if target is a cubicle
        if (step.target.startsWith('cubicle-')) {
            const agentKey = step.target.replace('cubicle-', '');
            swapCubicleSprite(agentKey, true);
        }

        // Show review overlays for review steps
        if (step.target === 'review') {
            showReviewOverlay();
        }
        if (step.target === 'exec-review') {
            showExecReviewOverlay();
        }

        // Show comic panel closeup for this step
        showComicForStep(stepIdx);

        // Update single ticker bar
        ticker.innerHTML = '<span class="ticker-step">STEP ' + (stepIdx + 1) + '/' + PIPELINE_STEPS.length + '</span>' + step.text;
        ticker.style.borderColor = step.color;
        ticker.classList.add('active');

        stepIdx++;
        setTimeout(nextStep, step.duration || 2500);
    }

    setTimeout(nextStep, 500);
}

// ============================================================
// CLICK HANDLERS — depth-based
// ============================================================
document.querySelectorAll('.room').forEach(el => {
    el.addEventListener('click', e => {
        e.stopPropagation();
        const agent = el.dataset.agent;
        if (el.dataset.zoom === 'true') {
            drillDown(agent);
        }
        // Cubicles: just flash on click (no info card)
        if (el.classList.contains('cubicle')) {
            el.classList.add('pipeline-pulse');
            setTimeout(() => el.classList.remove('pipeline-pulse'), 1000);
        }
    });
});

// ============================================================
// ARCHITECTURE COMPARISON — overlay
// ============================================================
function openComparison() {
    const overlay = document.getElementById('compareOverlay');
    if (overlay) {
        overlay.classList.add('active');
        console.log('%c📊 Architecture comparison opened', 'color: #457b9d; font-weight: bold;');
    }
}
function closeComparison() {
    const overlay = document.getElementById('compareOverlay');
    if (overlay) overlay.classList.remove('active');
}
// Click anywhere on comparison overlay to close
document.getElementById('compareOverlay')?.addEventListener('click', e => {
    if (e.target.closest('.compare-grid') || e.target.closest('.compare-title')) return;
    closeComparison();
});

// ============================================================
// ESCAPE KEY — close all overlays, drill up
// ============================================================
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        // Priority 1: Close schematic overlay (over brain)
        const schematic = document.getElementById('schematicOverlay');
        if (schematic && schematic.classList.contains('active')) {
            closeFullSchematic();
            return;
        }
        // Priority 2: Close brain overlay
        const brain = document.getElementById('brainOverlay');
        if (brain && brain.classList.contains('active')) {
            closeBrain();
            return;
        }
        // Priority 3: Close GPU guide
        const gpu = document.getElementById('gpuGuideOverlay');
        if (gpu && gpu.classList.contains('active')) {
            closeGpuGuide();
            return;
        }
        // Priority 4: Close comparison overlay
        const compare = document.getElementById('compareOverlay');
        if (compare && compare.classList.contains('active')) {
            closeComparison();
            return;
        }
        drillUp();
    }
});

// ============================================================
// GLOBAL IMAGE ERROR HANDLER — attach to all sprite-anim images
// ============================================================
document.querySelectorAll('img.sprite-anim').forEach(img => {
    img.onerror = function() { handleImgError(this); };
});

// ============================================================
// DEPTH-BASED ASSET PRELOADING
// ============================================================
const preloadedLayers = {};
function preloadLayer(layerNum) {
    if (preloadedLayers[layerNum]) return;
    preloadedLayers[layerNum] = true;

    const urls = [];
    if (layerNum === 0) {
        // Exterior: skyline images
        ['back', 'mid', 'front'].forEach(k => {
            const files = ASSETS.skyline[k];
            if (Array.isArray(files)) files.forEach(f => { if (f) urls.push(assetUrl(f)); });
            else if (files) urls.push(assetUrl(files));
        });
    } else if (layerNum === 1) {
        // Interior: office wide shots + cubicle backgrounds + loops + tubes
        Object.values(ASSETS.officeWide).forEach(f => { if (f) urls.push(assetUrl(f)); });
        Object.values(ASSETS.cubicles).forEach(f => { if (f) urls.push(assetUrl(f)); });
        if (ASSETS.cubicleLoops) Object.values(ASSETS.cubicleLoops).forEach(f => { if (f) urls.push(assetUrl(f)); });
        if (ASSETS.tubes) Object.values(ASSETS.tubes).forEach(f => { if (f) urls.push(assetUrl(f)); });
    } else if (layerNum === 2) {
        // Office zoom: all character sprites, office backgrounds, computer stills
        Object.values(ASSETS.officeBg).forEach(f => { if (f) urls.push(assetUrl(f)); });
        Object.values(ASSETS.computerStill).forEach(f => { if (f) urls.push(assetUrl(f)); });
        ['ari','kevin','henry','alex'].forEach(who => {
            const c = ASSETS.characters[who];
            if (!c) return;
            [c.humanIdle, c.agentIdle, c.agentLoop, c.agentOpen].forEach(f => {
                if (f) urls.push(assetUrl(f));
            });
        });
    } else if (layerNum === 3) {
        // Brain: component sprites + upgrade animations
        ['ollama','goose','claudeCode','memory'].forEach(k => {
            const b = ASSETS.brain[k];
            if (b && b.idle) urls.push(assetUrl(b.idle));
            if (b && b.reaction) urls.push(assetUrl(b.reaction));
            if (b && b.upgrade) urls.push(assetUrl(b.upgrade));
        });
        // Bot portraits for dossier tabs
        Object.values(BOT_SPECS).forEach(s => {
            if (s.portrait) urls.push(assetUrl(s.portrait));
        });
        // Burning tokens animation
        urls.push(assetUrl('claude_action_burning_tokens.webp'));
    }

    urls.forEach(url => {
        const img = new Image();
        img.src = url;
    });
    console.log(`🎭 BACKSTAGE: Preloading Layer ${layerNum} (${urls.length} assets)`);
}

// ============================================================
// INIT
// ============================================================
console.log('%c🎭 AGILE LENS v8 — PROSCENIUM THEATER', 'color: #c9a84c; font-size: 14px; font-weight: bold;');
console.log('GSAP STATUS:', typeof gsap !== 'undefined' ? 'LOADED v' + gsap.version : 'NOT LOADED — CSS fallback');
loadRoomBackgrounds();
loadSkyline();
depth = 0;
document.getElementById('exterior').classList.add('active');
updateSpotlights(0);
// Preload Layer 0 (exterior) immediately, Layer 1 (interior) shortly after
preloadLayer(0);
setTimeout(() => preloadLayer(1), 1000);

</script>
</body>
</html>
